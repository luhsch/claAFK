<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clã AFK | Minecraft</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #fff1f2; scroll-behavior: smooth; }
        .pink-gradient { background: linear-gradient(135deg, #fbcfe8 0%, #f9a8d4 100%); }
        .card-shadow { box-shadow: 0 10px 25px -5px rgba(244, 114, 182, 0.1), 0 8px 10px -6px rgba(244, 114, 182, 0.1); }
        .tab-active { color: #db2777; border-bottom: 3px solid #db2777; }
        .login-tab-active { border-bottom: 2px solid #db2777; color: #db2777; font-weight: 700; }
        .hidden { display: none; }
        @keyframes subtle-pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.9; } }
        @keyframes attention-pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7); transform: scale(1); } 50% { transform: scale(1.05); } 70% { box-shadow: 0 0 0 15px rgba(255, 255, 255, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); transform: scale(1); } }
        .recruitment-badge { animation: subtle-pulse 3s infinite ease-in-out; }
        .btn-attention { animation: attention-pulse 2s infinite; }
        .modal-bg { background-color: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
        .subtab-active { background-color: #db2777 !important; color: white !important; box-shadow: 0 4px 12px rgba(219, 39, 119, 0.3); }
        .mgmt-subtab-active { border-bottom: 3px solid #db2777; color: #db2777; }
    </style>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, updateDoc, addDoc, deleteDoc, setDoc, getDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAhbf0kBYCAWsQAPKYx4TPdud1O_GUjoU4",
            authDomain: "clan-afk.firebaseapp.com",
            projectId: "clan-afk",
            storageBucket: "clan-afk.firebasestorage.app",
            messagingSenderId: "1047971218666",
            appId: "1:1047971218666:web:e28db1fa82c140b565c393"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "clan-afk";

        // CONFIGURAÇÕES DE PERMISSÕES (CAPACIDADES) - SEPARADO ENTRE CLÃ E GLOBAL
        const PERMISSIONS_LIST = [
            { id: "MANAGE_RECRUITMENT", label: "Gerenciar Recrutamento (Aprovar/Negar)" },
            { id: "DELETE_RECRUITMENT", label: "Excluir Pedidos de Recrutamento" },
            { id: "MANAGE_ALLIANCES", label: "Gerenciar Alianças" },
            { id: "MANAGE_GLOBAL_EVENTS", label: "Criar/Editar Eventos GLOBAIS" },
            { id: "DELETE_GLOBAL_EVENTS", label: "Excluir Eventos GLOBAIS" },
            { id: "MANAGE_CLAN_EVENTS", label: "Criar/Editar Eventos do CLÃ" },
            { id: "DELETE_CLAN_EVENTS", label: "Excluir Eventos do CLÃ" },
            { id: "MANAGE_MISSIONS", label: "Gerenciar Missões" },
            { id: "DELETE_MISSIONS", label: "Excluir/Concluir Missões" },
            { id: "MANAGE_GLOBAL_GIVEAWAYS", label: "Gerenciar Sorteios GLOBAIS" },
            { id: "DELETE_GLOBAL_GIVEAWAYS", label: "Excluir Sorteios GLOBAIS" },
            { id: "MANAGE_CLAN_GIVEAWAYS", label: "Gerenciar Sorteios do CLÃ" },
            { id: "DELETE_CLAN_GIVEAWAYS", label: "Excluir Sorteios do CLÃ" },
            { id: "MANAGE_MEMBERS", label: "Gerenciar Membros (Editar Perfis/Autorizar)" },
            { id: "DELETE_MEMBERS", label: "Excluir Membros" },
            { id: "ACCESS_MGMT_TAB", label: "Acessar Aba Gerenciamento" }
        ];

        let currentUser = null;
        let allEvents = [];
        let allClanEvents = []; 
        let allAlliances = [];
        let allAllianceRequests = [];
        let allApplications = [];
        let allIdentities = [];
        let allUsers = []; // Lista de contas registradas
        let allMissions = [];
        let allCompletedMissions = []; 
        let allGiveaways = []; 
        let allClanGiveaways = []; 
        let allAuthorizedMembers = [];
        let allDynamicAllowedMembers = []; // Nova lista dinâmica de autorizados
        let allLogs = [];
        let hiddenStaticMembers = []; 
        let memberDetailsOverrides = {}; 
        let isRecruitmentOpen = true; 
        let individualPermissions = {}; // Carregado do Firestore
        
        let initialEventLoad = true;
        let initialClanEventLoad = true;
        let initialGiveawayLoad = true;
        let initialClanGiveawayLoad = true;
        let initialRecruitmentLoad = true;
        let initialRecruitmentListLoad = true; 
        
        let editingEventId = null;
        let editingClanEventId = null; 
        let eventToDeleteId = null;
        let clanEventToDeleteId = null; 
        let allianceToDeleteId = null;
        let applicationToDeleteId = null;
        let applicationToDeleteStatus = null; 
        let missionToDeleteId = null;
        let giveawayToDeleteId = null;
        let clanGiveawayToDeleteId = null;
        let memberToDelete = null; 
        let nickToResetAccount = null;
        
        let editingGiveawayId = null; 
        let editingClanGiveawayId = null;
        let editingMemberNick = null; 

        let editingEventAuthor = null;
        let editingClanEventAuthor = null;

        // Hierarquia Administrativa Dinâmica
        let dynamicRoles = {
            super_admins: { members: ["Luhnny", "Lagartuuuxaaa", "K0ssh1_", "AnnyGaby", "Radgridr"], permissions: ["MANAGE_RECRUITMENT", "MANAGE_ALLIANCES", "MANAGE_MEMBERS", "ACCESS_MGMT_TAB"] },
            event_admins: { members: ["SrLordM", "Bone"], permissions: ["MANAGE_GLOBAL_EVENTS", "MANAGE_GLOBAL_GIVEAWAYS"] },
            mission_admins: { members: ["Luhnny", "Lagartuuuxaaa", "K0ssh1_", "2aswd"], permissions: ["MANAGE_MISSIONS"] }
        };

        // FUNÇÃO CENTRAL DE PERMISSÃO - AGORA RESPEITANDO INDIVIDUAIS E CARGOS
        window.hasPermission = (permissionId) => {
            if (!currentUser) return false;
            if (currentUser.name === "Luhnny") return true; // Luhnny é imune e tem tudo

            // 1. Verificar Permissões Individuais (Prioridade)
            const userLower = currentUser.name.toLowerCase();
            if (individualPermissions[userLower] && individualPermissions[userLower].includes(permissionId)) {
                return true;
            }

            // 2. Verificar Permissões de Cargo
            for (const roleKey in dynamicRoles) {
                const role = dynamicRoles[roleKey];
                if (role.members.includes(currentUser.name)) {
                    if (Array.isArray(role.permissions) && role.permissions.includes(permissionId)) {
                        return true;
                    }
                }
            }
            return false;
        };

        const INVITE_CODE_MEMBER = "senhadificil"; 
        const INVITE_CODE_ALLY = "123alianca";

        const ALLOWED_MEMBERS = [
            "Luhnny", "K0ssh1_", "Pardas01", 
            "baiano019", "NeverPuzzle", 
            "felpipoca", "ynSunn", "TheP1nk", "2aswd", "festinha", "AnnyGaby", "Radgridr"
        ];

        const STATIC_MEMBERS = [
            { nick: "Luhnny", role: "Líder", tags: ["builder"], aniv: "17/10", disp: "Manhã e Noite", img: "luhnny.png" },
            { nick: "Radgridr", role: "Co-Líder", tags: ["membro"], aniv: "N/I", disp: "N/I", img: "https://ui-avatars.com/api/?name=Radgridr&background=f9a8d4&color=fff" },
            { nick: "AnnyGaby", role: "Co-Líder", tags: ["membro"], aniv: "N/I", disp: "N/I", img: "annygaby.png" },
            { nick: "K0ssh1_", role: "Co-Líder", tags: ["cpvp"], aniv: "27/04", disp: "13:30 - 01:30", img: "k0ssh1.png" },
            { nick: "Pardas01", tags: ["cpvp", "builder", "farm"], aniv: "16/06", disp: "Tarde e Noite", img: "pardas01.png" },
            { nick: "baiano019", tags: ["builder"], aniv: "14/05", disp: "Noite", img: "baiano019.png" },
            { nick: "Invisivel", tags: ["spvp", "cpvp", "builder", "farm"], aniv: "28/07", disp: "Noite", img: "invisivel.png" },
            { nick: "NeverPuzzle", tags: ["spvp", "cpvp", "farm"], aniv: "11/08", disp: "Tarde", img: "neverpuzzle.png" },
            { nick: "felpipoca", tags: ["spvp", "farm"], aniv: "21/01", disp: "Dia e Madrugada", img: "felpipoca.png" },
            { nick: "ynSunn", tags: ["spvp", "builder", "farm"], aniv: "23/08", disp: "Tarde e Noite", img: "ynsunn.png" },
            { nick: "TheP1nk", tags: ["pvp", "cpvp", "builder"], aniv: "10/07", disp: "Tarde e Noite", img: "thep1nk.png" },
            { nick: "2aswd", tags: ["spvp", "builder", "farm"], aniv: "20/05", disp: "Toda hora", img: "2aswd.png" },
            { nick: "festinha", tags: ["membro"], aniv: "N/I", disp: "N/I", img: "festinha.png" }
        ];

        const notifAudio = new Audio("https://assets.mixkit.co/active_storage/sfx/234/234-preview.mp3"); 
        const saveLog = async (action, details = "") => {
            if (!currentUser) return;
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'logs'), {
                    user: currentUser.name,
                    action: action,
                    details: details,
                    timestamp: Date.now()
                });
            } catch (e) { console.error("Erro ao salvar log:", e); }
        };

        window.notify = (msg, type, playSound = false) => {
            if (playSound) {
                notifAudio.currentTime = 0;
                notifAudio.play().catch(e => console.log("Áudio bloqueado."));
            }
            const t = document.getElementById('toast');
            if (!t) return;
            t.innerText = msg;
            t.className = `fixed bottom-10 left-1/2 -translate-x-1/2 px-6 py-3 rounded-2xl text-white font-bold shadow-2xl transition-all z-[1500] ${type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-pink-500'}`;
            t.style.display = 'block'; 
            setTimeout(() => { if(t) t.style.display = 'none'; }, 4000);
        };

        window.openModal = (id) => { 
            document.getElementById(id)?.classList.remove('hidden'); 
            if(id === 'modal-login') {
                setTimeout(() => document.getElementById('login-user')?.focus(), 100);
            } else {
                setTimeout(() => {
                    const firstInput = document.getElementById(id)?.querySelector('input, select, textarea');
                    if(firstInput) firstInput.focus();
                }, 100);
            }
        };
        window.closeModal = (id) => { document.getElementById(id)?.classList.add('hidden'); };

        window.loginSuccess = (userDoc) => {
            currentUser = userDoc;
            localStorage.setItem('afk_user', JSON.stringify(currentUser));
            window.updateUI();
            window.notify(`Olá, ${currentUser.name}!`, "success", false);
            window.closeModal('modal-login');
        };

        const syncUserIdentity = async (name, role) => {
            const identityRef = doc(db, 'artifacts', appId, 'public', 'data', 'ally_identities', name.toLowerCase());
            const identityData = { nick: name, createdAt: Date.now() };
            if (role === 'ally') identityData.deviceId = "auth_v2";
            else identityData.role = "member";
            await setDoc(identityRef, identityData);
        };

        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const openModals = document.querySelectorAll('.modal-bg:not(.hidden)');
                openModals.forEach(modal => window.closeModal(modal.id));
                return;
            }
            const activeModal = document.querySelector('.modal-bg:not(.hidden)');
            if (!activeModal) return;
            const inputs = Array.from(activeModal.querySelectorAll('input:not([type="hidden"]), select, textarea, button[type="submit"], .pink-gradient'));
            const currentIndex = inputs.indexOf(document.activeElement);
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                const nextIndex = (currentIndex + 1) % inputs.length;
                inputs[nextIndex].focus();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                const prevIndex = (currentIndex - 1 + inputs.length) % inputs.length;
                inputs[prevIndex].focus();
            } else if (e.key === 'Enter') {
                if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'SELECT') {
                    e.preventDefault();
                    const submitBtn = activeModal.querySelector('button[type="submit"], .pink-gradient, button.bg-pink-500, button.bg-purple-500, button.bg-green-500');
                    if (submitBtn) submitBtn.click();
                }
            }
        });

        window.toggleAuthMode = (mode) => {
            const loginForm = document.getElementById('auth-login-form');
            const registerForm = document.getElementById('auth-register-form');
            const tabLogin = document.getElementById('tab-mode-login');
            const tabRegister = document.getElementById('tab-mode-register');
            if (mode === 'login') {
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
                tabLogin.classList.add('text-pink-600', 'border-b-2', 'border-pink-600');
                tabLogin.classList.remove('text-slate-400');
                tabRegister.classList.remove('text-pink-600', 'border-b-2', 'border-pink-600');
                tabRegister.classList.add('text-slate-400');
                setTimeout(() => document.getElementById('login-user')?.focus(), 50);
            } else {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
                tabRegister.classList.add('text-pink-600', 'border-b-2', 'border-pink-600');
                tabRegister.classList.remove('text-pink-600', 'border-b-2', 'border-pink-600');
                tabLogin.classList.remove('text-pink-600', 'border-b-2', 'border-pink-600');
                tabLogin.classList.add('text-slate-400');
                window.populateAllySelectRegister();
                setTimeout(() => document.getElementById('reg-nick')?.focus(), 50);
            }
        };

        window.toggleRegisterType = () => {
            const type = document.getElementById('reg-type').value;
            const clanDiv = document.getElementById('reg-clan-div');
            if (type === 'ally') clanDiv.classList.remove('hidden');
            else clanDiv.classList.add('hidden');
        };

        window.handleLogin = async () => {
            const nick = document.getElementById('login-user').value.trim();
            const pass = document.getElementById('login-pass').value;
            if (!nick || !pass) return window.notify("Preencha todos os campos.", "error", false);
            try {
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', nick.toLowerCase());
                const userSnap = await getDoc(userRef);
                if (!userSnap.exists()) return window.notify("Usuário não encontrado. Crie uma conta.", "error", false);
                const userData = userSnap.data();
                if (userData.password !== pass) return window.notify("Senha incorreta.", "error", false);
                await updateDoc(userRef, { lastLogin: Date.now() });
                await syncUserIdentity(userData.name, userData.role);
                window.loginSuccess({ ...userData, isAlly: userData.role === 'ally' });
            } catch (e) {
                console.error(e);
                window.notify("Erro ao fazer login.", "error", false);
            }
        };

        window.forgotPassword = () => {
            window.notify("Fale com a Luhnny (@luhsch) no Discord para resetar sua senha!", "info");
        };

        window.handleRegister = async () => {
            const nick = document.getElementById('reg-nick').value.trim();
            const pass = document.getElementById('reg-pass').value;
            const type = document.getElementById('reg-type').value; 
            const clan = document.getElementById('reg-clan').value;
            const inviteCode = document.getElementById('reg-invite').value;
            if (!nick || !pass || !inviteCode) return window.notify("Preencha todos os campos.", "error", false);
            if (type === 'ally' && !clan) return window.notify("Selecione um clã.", "error", false);
            if (type === 'member' && inviteCode !== INVITE_CODE_MEMBER) return window.notify("Código de Membro incorreto.", "error", false);
            if (type === 'ally' && inviteCode !== INVITE_CODE_ALLY) return window.notify("Código de Aliado incorreto.", "error", false);
            let finalName = nick;
            if (type === 'member') {
                const staticMatch = ALLOWED_MEMBERS.find(m => m.toLowerCase() === nick.toLowerCase());
                const recruitMatch = allApplications.find(app => app.nick.toLowerCase() === nick.toLowerCase() && app.status === 'aprovado');
                const manualMatch = allAuthorizedMembers.find(m => m.nick.toLowerCase() === nick.toLowerCase());
                const dynamicMatch = allDynamicAllowedMembers.find(m => m.nick.toLowerCase() === nick.toLowerCase());
                
                if (!staticMatch && !recruitMatch && !manualMatch && !dynamicMatch) {
                    return window.notify("Este Nick não está autorizado a registrar-se como membro.", "error", false);
                }
                finalName = staticMatch || (recruitMatch ? recruitMatch.nick : (manualMatch ? manualMatch.nick : (dynamicMatch ? dynamicMatch.nick : nick)));
            }
            try {
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', finalName.toLowerCase());
                const userSnap = await getDoc(userRef);
                if (userSnap.exists()) return window.notify("Este usuário já está registrado. Faça login.", "error", false);
                const userData = { name: finalName, password: pass, role: type, clan: type === 'ally' ? clan : 'AFK', createdAt: Date.now() };
                await setDoc(userRef, userData);
                await syncUserIdentity(finalName, type);
                if (type === 'ally') {
                    let docAlly = allAlliances.find(a => a.name === clan);
                    if (docAlly) {
                        if (!(docAlly.members || []).includes(finalName)) {
                            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'alliances', docAlly.id), { members: [...(docAlly.members || []), finalName] });
                        }
                    } else {
                        const tag = clan.substring(0, 4).toUpperCase();
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'alliances'), { name: clan, tag, members: [finalName], createdAt: Date.now() });
                    }
                }
                window.notify("Conta criada com sucesso! Fazendo login...", "success", false);
                window.loginSuccess({ ...userData, isAlly: type === 'ally' });
            } catch (e) {
                console.error(e);
                window.notify("Erro ao registrar.", "error", false);
            }
        };

        window.switchTab = (tab) => {
            ['apresentacao', 'membros', 'area-cla', 'eventos', 'sorteios', 'aliancas', 'recrutamento', 'gerenciamento'].forEach(t => {
                const el = document.getElementById('tab-' + t);
                const btn = document.getElementById('btn-' + t);
                if (!el || !btn) return;
                if (t === tab) { el.classList.remove('hidden'); btn.classList.add('tab-active'); btn.classList.remove('text-pink-300'); } 
                else { el.classList.add('hidden'); btn.classList.remove('tab-active'); btn.classList.add('text-pink-300'); }
            });
            if(tab === 'area-cla') window.switchSubTab('eventos-cla');
            if(tab === 'gerenciamento') window.switchMgmtSubTab('logs-mgmt');
            lucide.createIcons();
        };

        window.switchSubTab = (sub) => {
            const tabs = ['eventos-cla', 'sorteios-cla', 'missoes-cla'];
            tabs.forEach(t => {
                const el = document.getElementById('subtab-' + t);
                const btn = document.getElementById('subbtn-' + t);
                if (t === sub) { 
                    el.classList.remove('hidden'); 
                    btn.classList.add('subtab-active'); 
                    btn.classList.remove('bg-slate-100', 'text-slate-500'); 
                } 
                else { 
                    el.classList.add('hidden'); 
                    btn.classList.remove('subtab-active'); 
                    btn.classList.add('bg-slate-100', 'text-slate-500'); 
                }
            });
            lucide.createIcons();
        };

        window.switchMgmtSubTab = (sub) => {
            ['logs-mgmt', 'permissions-mgmt'].forEach(t => {
                const el = document.getElementById('mgmt-content-' + t);
                const btn = document.getElementById('mgmt-btn-' + t);
                if (t === sub) { el.classList.remove('hidden'); btn.classList.add('mgmt-subtab-active'); } 
                else { el.classList.add('hidden'); btn.classList.remove('mgmt-subtab-active'); }
            });
            if (sub === 'permissions-mgmt') {
                window.renderPermissionsMgmt();
                window.renderAllowedListMgmt();
            }
            lucide.createIcons();
        };

        // GESTÃO DINÂMICA DE CARGOS E PERMISSÕES POR LUHNNY
        window.renderPermissionsMgmt = () => {
            const isLuhnny = currentUser && currentUser.name === "Luhnny";
            const container = document.getElementById('dynamic-permissions-grid');
            if (!container) return;
            container.innerHTML = '';

            Object.keys(dynamicRoles).forEach(roleKey => {
                const role = dynamicRoles[roleKey];
                const label = roleKey === 'super_admins' ? 'Admins Principais' : roleKey === 'event_admins' ? 'Admins de Eventos' : 'Admins de Missões';
                const icon = roleKey === 'super_admins' ? 'crown' : roleKey === 'event_admins' ? 'calendar' : 'scroll';
                const color = roleKey === 'super_admins' ? 'pink' : roleKey === 'event_admins' ? 'purple' : 'blue';

                // Renderiza Membros
                const membersList = role.members.map(m => `
                    <span class="bg-white px-2 py-1 rounded-md text-[10px] font-bold text-${color}-500 border border-${color}-100 flex items-center gap-1">
                        ${m}
                        ${isLuhnny && m !== 'Luhnny' ? `<button onclick="window.removeAdminRole('${roleKey}', '${m}')" class="text-red-400 hover:text-red-600 transition">×</button>` : ''}
                    </span>
                `).join('');

                const addMemberInput = isLuhnny ? `
                    <div class="mt-4 flex gap-2">
                        <input type="text" id="add-nick-${roleKey}" placeholder="Novo Admin..." class="flex-1 text-[10px] p-1.5 border rounded-lg outline-none focus:border-${color}-300">
                        <button onclick="window.addAdminRole('${roleKey}')" class="bg-${color}-500 text-white px-2 py-1 rounded-lg text-[10px] font-bold shadow-sm">ADD</button>
                    </div>
                ` : '';

                // Lista de Checkboxes de Permissões
                const permsCheckboxes = PERMISSIONS_LIST.map(p => {
                    const hasP = Array.isArray(role.permissions) && role.permissions.includes(p.id);
                    return `
                        <label class="flex items-center gap-2 p-1.5 hover:bg-slate-50 rounded-lg transition cursor-pointer">
                            <input type="checkbox" onchange="window.toggleRolePermission('${roleKey}', '${p.id}')" ${hasP ? 'checked' : ''} ${!isLuhnny ? 'disabled' : ''} class="w-3.5 h-3.5 rounded border-pink-300 text-pink-600 focus:ring-pink-500">
                            <span class="text-[11px] text-slate-600">${p.label}</span>
                        </label>
                    `;
                }).join('');

                container.innerHTML += `
                    <div class="bg-white p-6 rounded-2xl border-2 border-${color}-100 flex flex-col card-shadow">
                        <h3 class="font-bold text-${color}-600 uppercase text-sm mb-6 flex items-center gap-2 border-b border-${color}-50 pb-2"><i data-lucide="${icon}" class="w-4 h-4"></i> ${label}</h3>
                        
                        <div class="space-y-1 flex-grow">
                            <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest block mb-2">Permissões do Cargo:</span>
                            <div class="space-y-1 max-h-[180px] overflow-y-auto pr-1">
                                ${permsCheckboxes}
                            </div>
                        </div>

                        <div class="pt-6 border-t border-${color}-50 mt-6">
                            <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest block mb-2">Membros com este Cargo:</span>
                            <div class="flex flex-wrap gap-1 mt-2">${membersList}</div>
                            ${addMemberInput}
                        </div>
                    </div>
                `;
            });
            lucide.createIcons();
        };

        // GESTÃO DA LISTA DE AUTORIZADOS (ALLOW_LIST)
        window.renderAllowedListMgmt = () => {
            const isLuhnny = currentUser && currentUser.name === "Luhnny";
            const container = document.getElementById('allowed-members-list-mgmt');
            if (!container) return;
            container.innerHTML = '';

            if (allDynamicAllowedMembers.length === 0) {
                container.innerHTML = '<p class="text-xs text-slate-400 italic py-4">Nenhum membro autorizado via site ainda.</p>';
            } else {
                allDynamicAllowedMembers.forEach(m => {
                    container.innerHTML += `
                        <div class="bg-slate-50 p-3 rounded-xl border border-slate-200 flex items-center justify-between">
                            <span class="text-xs font-bold text-slate-600">${m.nick}</span>
                            ${isLuhnny ? `<button onclick="window.removeAllowedMember('${m.id}')" class="text-red-400 hover:text-red-600 transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : ''}
                        </div>
                    `;
                });
            }
            lucide.createIcons();
        };

        window.addAllowedMember = async () => {
            if (currentUser?.name !== "Luhnny") return;
            const input = document.getElementById('new-allowed-nick');
            const nick = input.value.trim();
            if (!nick) return;
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'allowed_list'), { nick, addedAt: Date.now() });
                await saveLog("Lista de Autorizados", `Adicionou ${nick} à lista de autorizados.`);
                input.value = "";
                window.notify(`${nick} autorizado!`, "success");
            } catch (e) { console.error(e); }
        };

        window.removeAllowedMember = async (id) => {
            if (currentUser?.name !== "Luhnny") return;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'allowed_list', id));
                await saveLog("Lista de Autorizados", `Removeu um membro da lista.`);
                window.notify("Autorização removida.", "info");
            } catch (e) { console.error(e); }
        };

        window.toggleRolePermission = async (roleKey, permId) => {
            if (currentUser?.name !== "Luhnny") return;
            const currentPerms = Array.isArray(dynamicRoles[roleKey].permissions) ? [...dynamicRoles[roleKey].permissions] : [];
            let updatedPerms;
            if (currentPerms.includes(permId)) {
                updatedPerms = currentPerms.filter(p => p !== permId);
            } else {
                updatedPerms = [...currentPerms, permId];
            }
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'permissions', roleKey), { ...dynamicRoles[roleKey], permissions: updatedPerms });
            await saveLog("Alteração de Permissões", `Alterou permissão ${permId} no cargo ${roleKey}.`);
            window.notify("Permissão do cargo atualizada!", "success");
        };

        window.removeAdminRole = async (roleKey, nick) => {
            if (currentUser?.name !== "Luhnny") return;
            const updatedMembers = dynamicRoles[roleKey].members.filter(m => m !== nick);
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'permissions', roleKey), { ...dynamicRoles[roleKey], members: updatedMembers });
            await saveLog("Alteração de Hierarquia", `Removeu ${nick} do cargo ${roleKey}.`);
            window.notify(`${nick} removido de ${roleKey}`, "info");
        };

        window.addAdminRole = async (roleKey) => {
            if (currentUser?.name !== "Luhnny") return;
            const input = document.getElementById(`add-nick-${roleKey}`);
            const nick = input.value.trim();
            if (!nick) return;
            if (dynamicRoles[roleKey].members.includes(nick)) return window.notify("Jogador já possui este cargo.", "error");
            
            const updatedMembers = [...dynamicRoles[roleKey].members, nick];
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'permissions', roleKey), { ...dynamicRoles[roleKey], members: updatedMembers });
            await saveLog("Alteração de Hierarquia", `Adicionou ${nick} ao cargo ${roleKey}.`);
            input.value = "";
            window.notify(`${nick} adicionado a ${roleKey}`, "success");
        };

        // GESTÃO INDIVIDUAL DE PERMISSÕES
        window.openIndividualPermissions = (nick) => {
            const nickLower = nick.toLowerCase();
            const userPerms = individualPermissions[nickLower] || [];
            document.getElementById('indiv-perm-nick').innerText = nick;
            const listContainer = document.getElementById('indiv-perms-checkboxes');
            listContainer.innerHTML = PERMISSIONS_LIST.map(p => `
                <label class="flex items-center gap-3 p-3 hover:bg-slate-50 rounded-xl transition cursor-pointer border border-slate-100">
                    <input type="checkbox" onchange="window.toggleIndividualPermission('${nick}', '${p.id}')" ${userPerms.includes(p.id) ? 'checked' : ''} class="w-4 h-4 rounded border-pink-300 text-pink-600 focus:ring-pink-500">
                    <span class="text-sm text-slate-700 font-medium">${p.label}</span>
                </label>
            `).join('');
            window.openModal('modal-individual-permissions');
        };

        window.toggleIndividualPermission = async (nick, permId) => {
            if (currentUser?.name !== "Luhnny") return;
            const nickLower = nick.toLowerCase();
            const currentPerms = individualPermissions[nickLower] || [];
            let updatedPerms;
            if (currentPerms.includes(permId)) {
                updatedPerms = currentPerms.filter(p => p !== permId);
            } else {
                updatedPerms = [...currentPerms, permId];
            }
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'individual_permissions', nickLower), { permissions: updatedPerms, nick: nick });
            await saveLog("Permissão Individual", `Alterou permissões de ${nick}: ${permId}`);
            window.notify(`Acesso de ${nick} atualizado!`, "success");
        };

        window.addMemberManual = async () => {
            const nick = document.getElementById('add-manual-nick').value.trim();
            if (!nick) return window.notify("Digite o Nick.", "error");
            try {
                // Ao adicionar manualmente, damos permissão automática no Firestore
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'authorized_members', nick.toLowerCase()), { nick, addedAt: Date.now(), addedBy: currentUser.name });
                await saveLog("Autorização de Membro", `Membro ${nick} autorizado manualmente.`);
                window.notify(`Membro ${nick} autorizado com sucesso!`, "success");
                window.closeModal('modal-add-member-manual');
                document.getElementById('add-manual-nick').value = "";
            } catch (e) { console.error(e); window.notify("Erro ao autorizar membro.", "error"); }
        };

        window.requestResetAccount = (nick) => {
            if (!nick) return window.notify("Digite o nick do jogador!", "error");
            nickToResetAccount = nick;
            document.getElementById('reset-nick-display').innerText = nick;
            window.openModal('modal-confirm-account-reset');
        };

        window.confirmAccountReset = async () => {
            if (!nickToResetAccount) return;
            try {
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', nickToResetAccount.toLowerCase());
                const identityRef = doc(db, 'artifacts', appId, 'public', 'data', 'ally_identities', nickToResetAccount.toLowerCase());
                await deleteDoc(userRef);
                await deleteDoc(identityRef);
                await saveLog("Reset de Conta", `Conta de ${nickToResetAccount} foi resetada.`);
                window.notify(`A conta de ${nickToResetAccount} foi resetada. Agora o jogador pode se cadastrar novamente!`, "success");
                window.closeModal('modal-confirm-account-reset');
                nickToResetAccount = null;
            } catch (e) { console.error(e); window.notify("Erro ao resetar conta.", "error"); }
        };

        window.renderMembers = () => {
            const grid = document.getElementById('members-grid'); 
            const countEl = document.getElementById('members-count');
            if(!grid) return;
            const getMemberData = (baseData) => {
                const override = memberDetailsOverrides[baseData.nick.toLowerCase()];
                if (override) {
                    return { ...baseData, aniv: override.aniv || baseData.aniv, disp: override.disp || baseData.disp, img: override.img || baseData.img, tags: override.tags ? override.tags : baseData.tags };
                }
                return baseData;
            };
            const approvedMembers = allApplications.filter(app => app.status === 'aprovado').map(app => {
                const tags = [];
                const combat = (app.combate || '').toLowerCase();
                if(combat.includes('cpvp') || combat.includes('ambos')) tags.push('cpvp');
                if(combat.includes('spvp') || combat.includes('ambos')) tags.push('spvp');
                if(combat.includes('pvp')) tags.push('pvp');
                const build = (app.build || '').toLowerCase();
                if(build.includes('sou bom') || build.includes('básico')) tags.push('builder');
                const farm = (app.farm || '').toLowerCase();
                if(farm.includes('sou bom') || farm.includes('básico')) tags.push('farm');
                if(tags.length === 0) tags.push('membro');
                return getMemberData({ id: app.id, nick: app.nick, role: null, tags: tags, aniv: app.aniversario || 'N/I', disp: app.horarios || app.tempo + 'h', img: `https://ui-avatars.com/api/?name=${app.nick}&background=f9a8d4&color=fff`, isStatic: false });
            });
            const manualMembers = allAuthorizedMembers.map(m => getMemberData({ nick: m.nick, tags: ["membro"], aniv: "N/I", disp: "N/I", img: `https://ui-avatars.com/api/?name=${m.nick}&background=f9a8d4&color=fff`, isStatic: false, isManual: true, id: m.id }));
            const visibleStaticMembers = STATIC_MEMBERS.filter(m => !hiddenStaticMembers.includes(m.nick)).map(m => getMemberData({...m, isStatic: true}));
            const combinedMembers = [...visibleStaticMembers];
            [...approvedMembers, ...manualMembers].forEach(newM => {
                if (!combinedMembers.some(m => m.nick.toLowerCase() === newM.nick.toLowerCase())) { combinedMembers.push(newM); }
            });
            if(countEl) countEl.innerText = `Total: ${combinedMembers.length} membros registrados`;
            grid.innerHTML = '';
            const isLuhnny = currentUser && currentUser.name === "Luhnny";
            const canManageMembers = window.hasPermission('MANAGE_MEMBERS');
            const canDeleteMembers = window.hasPermission('DELETE_MEMBERS');

            combinedMembers.forEach(m => {
                let tagsHtml = '';
                if(m.role) tagsHtml += `<span class="px-3 py-1 bg-pink-600 text-white text-[10px] font-bold uppercase rounded-full">${m.role}</span>`;
                (m.tags || []).forEach(t => {
                    let color = 'bg-slate-100 text-slate-600';
                    const tl = t.toLowerCase();
                    if (tl === 'cpvp') color = 'bg-red-100 text-red-600';
                    if (tl === 'spvp') color = 'bg-blue-100 text-blue-600';
                    if (tl === 'builder' || tl === 'build' || tl === 'construção') color = 'bg-yellow-100 text-yellow-600';
                    if (tl === 'farm') color = 'bg-green-100 text-green-600';
                    if (tl === 'pvp') color = 'bg-purple-100 text-purple-600';
                    if (tl === 'eventos') color = 'bg-purple-100 text-purple-600';
                    if (tl === 'membro') color = 'bg-slate-200 text-slate-500';
                    tagsHtml += `<span class="px-2 py-1 ${color} text-[10px] uppercase rounded-full font-bold">${t}</span>`;
                });
                let adminBtns = '';
                if (canManageMembers || canDeleteMembers || isLuhnny) {
                    const mData = JSON.stringify(m).replace(/'/g, "&#39;").replace(/"/g, "&quot;");
                    adminBtns = `<div class="absolute top-4 right-4 flex gap-1 z-10">
                        ${isLuhnny ? `<button title="Permissões" onclick="window.openIndividualPermissions('${m.nick}')" class="p-1.5 bg-white text-purple-400 hover:text-purple-600 rounded-lg shadow-sm border border-slate-100 transition"><i data-lucide="shield" class="w-4 h-4"></i></button>` : ''}
                        ${isLuhnny ? `<button title="Resetar Senha" onclick="window.requestResetAccount('${m.nick}')" class="p-1.5 bg-white text-pink-400 hover:text-pink-600 rounded-lg shadow-sm border border-slate-100 transition"><i data-lucide="key" class="w-4 h-4"></i></button>` : ''}
                        ${canManageMembers ? `<button onclick='window.openEditMemberModal(${mData})' class="p-1.5 bg-white text-blue-400 hover:text-blue-600 rounded-lg shadow-sm border border-slate-100 transition"><i data-lucide="pencil" class="w-4 h-4"></i></button>` : ''}
                        ${canDeleteMembers ? `<button onclick='window.requestDeleteMember(${mData})' class="p-1.5 bg-white text-red-300 hover:text-red-500 rounded-lg shadow-sm border border-slate-100 transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : ''}
                    </div>`;
                }
                const card = `<div class="relative bg-white p-6 rounded-3xl card-shadow border border-pink-100 flex flex-col ${m.role === 'Líder' || m.role === 'Co-Líder' ? 'border-2 border-pink-300 scale-105 transform' : ''}">${adminBtns}<div class="flex justify-between items-start mb-4"><h3 class="text-xl font-bold ${m.role === 'Líder' ? 'text-pink-600' : 'text-pink-500'} flex items-center gap-2">${m.nick} ${m.role === 'Líder' ? '<i data-lucide="crown" class="w-5 h-5 text-yellow-400"></i>' : (m.role === 'Co-Líder' ? '<i data-lucide="star" class="w-5 h-5 text-yellow-300"></i>' : '')}</h3><img src="${m.img}" onerror="this.src='https://ui-avatars.com/api/?name=${m.nick}&background=f9a8d4&color=fff'" class="w-16 h-16 rounded-2xl object-cover border-2 border-pink-100"></div><div class="space-y-3 mb-6 flex-grow text-sm"><div class="flex items-center gap-3 font-medium text-slate-600">Aniversário: ${m.aniv}</div><div class="flex items-center gap-3 font-medium text-slate-600">Disponível: ${m.disp}</div></div><div class="flex flex-wrap gap-2 pt-4 border-t border-pink-50">${tagsHtml}</div></div>`;
                grid.innerHTML += card;
            });
            lucide.createIcons();
        };

        window.openEditMemberModal = (member) => {
            editingMemberNick = member.nick;
            document.getElementById('edit-mem-nick').innerText = member.nick;
            document.getElementById('edit-mem-aniv').value = member.aniv;
            document.getElementById('edit-mem-disp').value = member.disp;
            document.getElementById('edit-mem-tags').value = (member.tags || []).join(', ');
            document.getElementById('edit-mem-img-input').value = ""; 
            window.openModal('modal-edit-member');
        };

        window.saveMemberEdit = async () => {
            if (!editingMemberNick) return;
            const aniv = document.getElementById('edit-mem-aniv').value.trim();
            const disp = document.getElementById('edit-mem-disp').value.trim();
            const tagsStr = document.getElementById('edit-mem-tags').value.trim();
            const tags = tagsStr.split(',').map(t => t.trim()).filter(t => t.length > 0);
            const fileInput = document.getElementById('edit-mem-img-input');
            let imgBase64 = null;
            if (fileInput.files && fileInput.files[0]) {
                const file = fileInput.files[0];
                if (file.size > 800000) return window.notify("Imagem muito pesada! Máximo 800KB.", "error");
                imgBase64 = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(file);
                });
            }
            const updateData = { aniv, disp, tags };
            if (imgBase64) updateData.img = imgBase64;
            try {
                const currentRef = doc(db, 'artifacts', appId, 'public', 'data', 'member_details', editingMemberNick.toLowerCase());
                const currentSnap = await getDoc(currentRef);
                const finalData = currentSnap.exists() ? { ...currentSnap.data(), ...updateData } : updateData;
                await setDoc(currentRef, finalData);
                await saveLog("Edição de Perfil", `Editou dados de ${editingMemberNick}.`);
                window.notify(`Dados de ${editingMemberNick} atualizados!`, "success", false);
                window.closeModal('modal-edit-member');
            } catch (e) { console.error(e); window.notify("Erro ao salvar alterações.", "error", false); }
        };

        window.requestDeleteMember = (member) => {
            memberToDelete = member;
            window.openModal('modal-confirm-member-delete');
        };

        window.confirmMemberDelete = async () => {
            if (!memberToDelete) return;
            try {
                if (memberToDelete.isStatic) {
                    const settingsRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'hidden_members');
                    const snap = await getDoc(settingsRef);
                    let currentList = [];
                    if (snap.exists()) currentList = snap.data().nicks || [];
                    if (!currentList.includes(memberToDelete.nick)) {
                        await setDoc(settingsRef, { nicks: [...currentList, memberToDelete.nick] });
                    }
                } else if (memberToDelete.isManual) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'authorized_members', memberToDelete.nick.toLowerCase()));
                } else {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'recruitment', memberToDelete.id), { status: 'removed' });
                }
                
                // Revogação Automática: Deletar a conta do usuário para invalidar acesso como membro
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', memberToDelete.nick.toLowerCase());
                await deleteDoc(userRef);
                
                await saveLog("Remoção de Membro", `Removeu ${memberToDelete.nick} do clã e revogou seu acesso automático.`);
                window.notify(`Membro ${memberToDelete.nick} removido e acesso revogado.`, "success", false);
            } catch (e) { console.error(e); window.notify("Erro ao remover membro.", "error", false); }
            window.closeModal('modal-confirm-member-delete');
            memberToDelete = null;
        };

        window.createMission = async () => {
            const objective = document.getElementById('mis-objective').value.trim();
            const reward = document.getElementById('mis-reward').value.trim();
            const tag = document.getElementById('mis-tag').value;
            if (!objective || !reward || !tag) return window.notify("Preencha todos os campos da missão.", "error", false);
            const canManageMissions = window.hasPermission('MANAGE_MISSIONS');
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'missions'), { objective, reward, tag, status: canManageMissions ? 'open' : 'suggestion', takenBy: null, createdBy: currentUser.name, createdAt: Date.now() });
            await saveLog(canManageMissions ? "Criação de Missão" : "Sugestão de Missão", `${objective} - Recompensa: ${reward}`);
            window.notify(canManageMissions ? "Missão criada!" : "Sugestão de missão enviada para a Luhnny!", "success", false);
            window.closeModal('modal-create-mission');
            document.getElementById('form-create-mission').reset();
        };

        window.approveMission = async (id) => {
            const mis = allMissions.find(m => m.id === id);
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'missions', id), { status: 'open' });
            await saveLog("Aprovação de Missão", `Aprovou a missão: ${mis?.objective}`);
            window.notify("Missão aprovada!", "success");
        };

        window.takeMission = async (id) => {
            if (!currentUser) return;
            const myMissions = allMissions.filter(m => m.takenBy === currentUser.name && m.status === 'taken');
            if (myMissions.length >= 2) return window.notify("Você já possui 2 missões em andamento!", "error", false);
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'missions', id), { status: 'taken', takenBy: currentUser.name });
            window.notify("Você aceitou a missão!", "success", false);
        };

        window.quitMission = async (id) => {
            if (!currentUser) return;
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'missions', id), { status: 'open', takenBy: null });
            window.notify("Você desistiu da missão.", "info", false);
        };

        window.requestDeleteMission = (id) => {
            missionToDeleteId = id;
            window.openModal('modal-confirm-mission-delete');
        };

        window.confirmMissionDelete = async () => {
            if (missionToDeleteId) {
                const mission = allMissions.find(m => m.id === missionToDeleteId);
                if (mission && mission.status === 'taken') {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'completed_missions'), { objective: mission.objective, reward: mission.reward, tag: mission.tag, takenBy: mission.takenBy, createdBy: mission.createdBy, paymentConfirmed: false, completedAt: Date.now() });
                    await saveLog("Missão Concluída", `Membro ${mission.takenBy} concluiu a missão: ${mission.objective}`);
                } else if (mission) {
                    await saveLog("Remoção de Missão", `Removeu la missão aberta: ${mission.objective}`);
                }
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'missions', missionToDeleteId));
                window.notify("Missão concluída com sucesso!", "success", false);
                window.closeModal('modal-confirm-mission-delete');
            }
        };

        window.confirmMissionPayment = async (id) => {
            try {
                const mis = allCompletedMissions.find(m => m.id === id);
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'completed_missions', id), { paymentConfirmed: true });
                await saveLog("Pagamento Confirmado", `Pagamento confirmado para ${mis?.takenBy} - Missão: ${mis?.objective}`);
                window.notify("Pagamento confirmado!", "success");
            } catch (e) { console.error(e); window.notify("Erro ao confirmar pagamento.", "error"); }
        };

        window.renderMissions = function() {
            const list = document.getElementById('missions-list'); if(!list) return;
            const historyList = document.getElementById('completed-missions-list'); if(!historyList) return;
            const suggList = document.getElementById('suggested-missions-list');
            const suggSection = document.getElementById('mission-suggestions-section');
            list.innerHTML = '';
            historyList.innerHTML = '';
            if(suggList) suggList.innerHTML = '';
            const canManage = window.hasPermission('MANAGE_MISSIONS');
            const canDeleteMissions = window.hasPermission('DELETE_MISSIONS');
            const suggestions = allMissions.filter(m => m.status === 'suggestion');
            if (canManage && suggestions.length > 0) { suggSection?.classList.remove('hidden'); 
                suggestions.forEach(m => {
                    suggList.innerHTML += `<div class="bg-yellow-50 border-2 border-yellow-200 p-6 rounded-3xl card-shadow flex flex-col justify-between"><div><span class="bg-yellow-200 text-yellow-700 px-3 py-1 rounded-lg text-[10px] font-bold uppercase w-fit mb-3 block">Sugestão de ${m.createdBy}</span><h4 class="text-lg font-bold text-slate-700 mb-2 leading-tight">${m.objective}</h4><p class="text-sm text-pink-500 font-semibold mb-4">Recompensa: ${m.reward}</p></div><div class="flex gap-2 border-t border-yellow-100 pt-4"><button onclick="window.approveMission('${m.id}')" class="flex-1 bg-green-500 text-white py-2 rounded-xl font-bold text-xs uppercase shadow-md hover:bg-green-600 transition">Aprovar</button><button onclick="window.requestDeleteMission('${m.id}')" class="px-4 bg-red-100 text-red-500 rounded-xl font-bold text-xs uppercase hover:bg-red-200 transition">Recusar</button></div></div>`;
                });
            } else { suggSection?.classList.add('hidden'); }
            const activeMissions = allMissions.filter(m => m.status !== 'suggestion');
            if (activeMissions.length === 0) { list.innerHTML = '<div class="col-span-full text-center p-8 bg-white rounded-3xl border-2 border-dashed border-pink-200 text-slate-400">Nenhuma missão disponível no momento.</div>'; } 
            else {
                activeMissions.sort((a,b) => b.createdAt - a.createdAt).forEach(m => {
                    const isTaken = m.status === 'taken';
                    const isMyMission = currentUser && m.takenBy === currentUser.name;
                    let buttonHtml = '';
                    if (canDeleteMissions) { buttonHtml = `<button onclick="window.requestDeleteMission('${m.id}')" class="w-full mt-4 py-2 rounded-xl border-2 border-red-100 text-red-400 font-bold hover:bg-red-50 transition uppercase text-xs">Concluir / Excluir</button>`; } 
                    else if (isTaken) {
                        if (isMyMission) { buttonHtml = `<div class="grid grid-cols-2 gap-2 mt-4"><button onclick="window.requestDeleteMission('${m.id}')" class="py-2 bg-green-500 text-white rounded-xl font-bold text-xs uppercase shadow-md hover:bg-green-600 transition">Concluído</button><button onclick="window.quitMission('${m.id}')" class="py-2 bg-slate-200 text-slate-600 rounded-xl font-bold text-xs uppercase hover:bg-slate-300 transition">Desistir</button></div>`; } 
                        else { buttonHtml = `<div class="w-full mt-4 py-2 bg-slate-50 text-slate-400 rounded-xl font-bold text-xs uppercase text-center border">Em andamento</div>`; }
                    } else { buttonHtml = `<button onclick="window.takeMission('${m.id}')" class="w-full mt-4 py-3 rounded-xl pink-gradient text-white font-bold shadow-lg transition active:scale-95 uppercase tracking-tighter hover:shadow-xl">Aceitar Missão</button>`; }
                    let statusBadge = isTaken ? `<span class="bg-yellow-100 text-yellow-600 px-3 py-1 rounded-full text-[10px] font-bold uppercase flex items-center gap-1"><i data-lucide="user"></i> ${m.takenBy}</span>` : `<span class="bg-green-100 text-green-600 px-3 py-1 rounded-full text-[10px] font-bold uppercase">Disponível</span>`;
                    let tagColor = "bg-slate-100 text-slate-500";
                    if(m.tag === 'Farm') tagColor = "bg-green-500 text-white";
                    if(m.tag === 'Build') tagColor = "bg-amber-500 text-white";
                    if(m.tag === 'Recursos') tagColor = "bg-blue-500 text-white";
                    if(m.tag === 'Exploração') tagColor = "bg-purple-500 text-white";
                    list.innerHTML += `<div class="bg-white p-6 rounded-3xl card-shadow border-2 ${isTaken ? 'border-yellow-100 opacity-90' : 'border-pink-200'} transition hover:scale-[1.01] flex flex-col"><div class="flex justify-between items-start mb-4"><div class="flex flex-col gap-2"><span class="px-3 py-1 rounded-lg text-[10px] font-bold uppercase w-fit ${tagColor}">${m.tag || 'Missão'}</span><div class="p-3 bg-pink-50 rounded-2xl text-pink-500 w-fit"><i data-lucide="scroll" class="w-6 h-6"></i></div></div>${statusBadge}</div><h4 class="text-lg font-bold text-slate-700 mb-2 leading-tight">${m.objective}</h4><p class="text-sm text-pink-500 font-semibold flex items-center gap-2 bg-pink-50/50 p-2 rounded-lg border border-pink-50 mb-4"><i data-lucide="gift" class="w-4 h-4"></i> Recompensa: ${m.reward}</p><div class="mt-auto pt-4 border-t border-slate-50 text-[10px] text-slate-400 font-bold uppercase tracking-wider">Criada por: <span class="text-pink-400">${m.createdBy || 'Luhnny'}</span></div>${buttonHtml}</div>`;
                });
            }
            if (allCompletedMissions.length === 0) { historyList.innerHTML = '<div class="col-span-full text-center p-6 text-slate-400 italic text-sm">Nenhuma missão concluída ainda.</div>'; } 
            else {
                allCompletedMissions.sort((a,b) => b.completedAt - a.completedAt).forEach(m => {
                    const dateStr = new Date(m.completedAt).toLocaleDateString('pt-PT');
                    const isOwner = currentUser && m.createdBy === currentUser.name;
                    let paymentStatusHtml = '';
                    if (m.paymentConfirmed) { paymentStatusHtml = `<div class="bg-white px-3 py-1 rounded-lg border border-green-100 text-[10px] font-bold text-green-500 uppercase flex items-center gap-1"><i data-lucide="award" class="w-3 h-3"></i> Recompensa Paga</div>`; } 
                    else if (isOwner || canManage) { paymentStatusHtml = `<button onclick="window.confirmMissionPayment('${m.id}')" class="bg-pink-500 text-white px-3 py-1 rounded-lg text-[10px] font-bold uppercase hover:bg-pink-600 transition shadow-sm">Confirmar Pagamento</button>`; } 
                    else { paymentStatusHtml = `<div class="bg-white px-3 py-1 rounded-lg border border-yellow-100 text-[10px] font-bold text-yellow-500 uppercase flex items-center gap-1"><i data-lucide="clock" class="w-3 h-3"></i> Aguardando Confirmação</div>`; }
                    historyList.innerHTML += `<div class="bg-slate-50/80 p-4 rounded-2xl border border-slate-100 flex flex-col md:flex-row md:items-center justify-between gap-4"><div class="flex items-center gap-4"><div class="p-2 bg-green-100 text-green-600 rounded-lg"><i data-lucide="check" class="w-5 h-5"></i></div><div><h5 class="font-bold text-slate-700 text-sm">${m.objective}</h5><p class="text-[10px] text-slate-500 font-bold uppercase tracking-tight mb-1">Recompensa: <span class="text-pink-600 font-extrabold">${m.reward}</span></p><p class="text-[9px] text-slate-400 font-bold uppercase tracking-tight">Cumprida por: <span class="text-pink-500">${m.takenBy}</span> | Dono: <span class="text-slate-600">${m.createdBy}</span> | Em ${dateStr}</p></div></div>${paymentStatusHtml}</div>`;
                });
            }
            lucide.createIcons();
        };

        window.saveGiveaway = async (isClan = false) => {
            const prefix = isClan ? 'clan-giv-' : 'giv-';
            const prize = document.getElementById(prefix + 'prize').value.trim();
            const date = document.getElementById(prefix + 'date').value;
            const time = document.getElementById(prefix + 'time').value;
            if (!prize || !date || !time) return window.notify("Preencha todos os campos do sorteio.", "error", false);
            const data = { prize, date, time };
            const coll = isClan ? 'clan_giveaways' : 'giveaways';
            const editId = isClan ? editingClanGiveawayId : editingGiveawayId;
            
            // SEPARADO: Permissão CLÃ ou GLOBAL
            const canManage = isClan ? window.hasPermission('MANAGE_CLAN_GIVEAWAYS') : window.hasPermission('MANAGE_GLOBAL_GIVEAWAYS');

            if (editId) {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', coll, editId), data);
                await saveLog("Edição de Sorteio", `Editou prêmio para: ${prize} (${isClan ? 'Clã' : 'Global'})`);
                window.notify("Sorteio Atualizado!", "success", false);
            } else {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', coll), { ...data, participants: [], winner: null, status: canManage ? 'open' : 'suggestion', createdBy: currentUser.name, createdAt: Date.now() });
                await saveLog(isClan && !canManage ? "Sugestão de Sorteio" : "Criação de Sorteio", `Prêmio: ${prize} (${isClan ? 'Clã' : 'Global'})`);
                window.notify(isClan && !canManage ? "Sugestão de sorteio enviada!" : "Sorteio Criado!", "success", false);
            }
            window.closeModal(isClan ? 'modal-create-clan-giveaway' : 'modal-create-giveaway');
            document.getElementById(isClan ? 'form-create-clan-giveaway' : 'form-create-giveaway').reset();
            if(isClan) editingClanGiveawayId = null; else editingGiveawayId = null;
        };

        window.approveClanGiveaway = async (id) => {
            const giv = allClanGiveaways.find(g => g.id === id);
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'clan_giveaways', id), { status: 'open' });
            await saveLog("Aprovação de Sorteio", `Aprovou prêmio: ${giv?.prize}`);
            window.notify("Sorteio do clã aprovado!", "success", false);
        };

        window.openCreateGiveawayModal = (isClan = false) => {
            if(isClan) {
                editingClanGiveawayId = null;
                document.getElementById('form-create-clan-giveaway').reset();
                document.getElementById('modal-title-clan-giveaway').innerText = "Novo Sorteio do Clã";
                window.openModal('modal-create-clan-giveaway');
            } else {
                editingGiveawayId = null;
                document.getElementById('form-create-giveaway').reset();
                document.getElementById('modal-title-giveaway').innerText = "Novo Sorteio";
                window.openModal('modal-create-giveaway');
            }
        };

        window.editGiveaway = (id, isClan = false) => {
            const list = isClan ? allClanGiveaways : allGiveaways;
            const prefix = isClan ? 'clan-giv-' : 'giv-';
            const g = list.find(x => x.id === id);
            if (!g) return;
            if(isClan) { editingClanGiveawayId = id; document.getElementById('modal-title-clan-giveaway').innerText = "Editar Sorteio do Clã"; window.openModal('modal-create-clan-giveaway'); } 
            else { editingGiveawayId = id; document.getElementById('modal-title-giveaway').innerText = "Editar Sorteio"; window.openModal('modal-create-giveaway'); }
            document.getElementById(prefix + 'prize').value = g.prize;
            document.getElementById(prefix + 'date').value = g.date;
            document.getElementById(prefix + 'time').value = g.time;
        };

        window.removeEventParticipant = async (id, nick, isClan) => {
            const canManage = isClan ? window.hasPermission('MANAGE_CLAN_EVENTS') : window.hasPermission('MANAGE_GLOBAL_EVENTS');
            if (!canManage) return;
            const list = isClan ? allClanEvents : allEvents;
            const coll = isClan ? 'clan_events' : 'events';
            const ev = list.find(e => e.id === id);
            if (ev && ev.participants) {
                const next = ev.participants.filter(p => p !== nick);
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'coll', id), { participants: next });
                await saveLog("Remoção de Participante (Evento)", `Removeu ${nick} do evento ${ev.title}`);
                window.notify(`Removido(a): ${nick}`, "info");
            }
        };

        window.removeGiveawayParticipant = async (id, nick, isClan) => {
            const canManage = isClan ? window.hasPermission('MANAGE_CLAN_GIVEAWAYS') : window.hasPermission('MANAGE_GLOBAL_GIVEAWAYS');
            if (!canManage) return;
            const list = isClan ? allClanGiveaways : allGiveaways;
            const coll = isClan ? 'clan_giveaways' : 'giveaways';
            const giv = list.find(g => g.id === id);
            if (giv && giv.participants) {
                const next = giv.participants.filter(p => p !== nick);
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', coll, id), { participants: next });
                await saveLog("Remoção de Participante (Sorteio)", `Removeu ${nick} do sorteio ${giv.prize}`);
                window.notify(`Removido(a): ${nick}`, "info");
                setTimeout(() => window.viewParticipants(id, isClan), 200);
            }
        };

        window.viewParticipants = (id, isClan = false) => {
            const list = isClan ? allClanGiveaways : allGiveaways;
            const g = list.find(x => x.id === id);
            const listContainer = document.getElementById('participants-list-content');
            const totalEl = document.getElementById('participants-total-count');
            const canKick = isClan ? window.hasPermission('MANAGE_CLAN_GIVEAWAYS') : window.hasPermission('MANAGE_GLOBAL_GIVEAWAYS');
            listContainer.innerHTML = '';
            if (g && g.participants && g.participants.length > 0) {
                totalEl.innerText = `${g.participants.length} Participantes`;
                g.participants.forEach(p => {
                    listContainer.innerHTML += `<div class="flex items-center gap-3 p-3 bg-pink-50 rounded-xl border border-pink-100"><img src="https://ui-avatars.com/api/?name=${p}&background=fbcfe8&color=db2777" class="w-8 h-8 rounded-full"><span class="font-bold text-slate-700">${p}</span>${canKick ? `<button onclick="window.removeGiveawayParticipant('${g.id}', '${p}', ${isClan})" class="ml-auto p-1.5 text-red-300 hover:text-red-500 transition"><i data-lucide="user-x" class="w-4 h-4"></i></button>` : ''}</div>`;
                });
            } else {
                totalEl.innerText = "0 Participantes";
                listContainer.innerHTML = '<div class="col-span-full text-center text-slate-400 italic py-4">Ninguém participando ainda.</div>';
            }
            window.openModal('modal-view-participants');
            lucide.createIcons();
        };

        window.joinGiveaway = async (id, isClan = false) => {
            if (!currentUser) return;
            const list = isClan ? allClanGiveaways : allGiveaways;
            const coll = isClan ? 'clan_giveaways' : 'giveaways';
            const giv = list.find(g => g.id === id);
            if (!giv) return;
            const currentParts = giv.participants || [];
            if (currentParts.includes(currentUser.name)) return window.notify("Você já está participando!", "info", false);
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', coll, id), { participants: [...currentParts, currentUser.name] });
            window.notify("Participação confirmada!", "success", false);
        };

        window.runGiveawayDraw = async (id, isClan = false) => {
            const list = isClan ? allClanGiveaways : allGiveaways;
            const coll = isClan ? 'clan_giveaways' : 'giveaways';
            const giv = list.find(g => g.id === id);
            if (!giv) return;
            const canDraw = isClan ? window.hasPermission('MANAGE_CLAN_GIVEAWAYS') : window.hasPermission('MANAGE_GLOBAL_GIVEAWAYS');
            const isCreator = currentUser && (giv.createdBy === currentUser.name);
            if (!canDraw && !isCreator) return window.notify("Apenas a liderança ou o criador podem realizar o sorteio.", "error", false);
            if (!giv.participants || giv.participants.length === 0) return window.notify("Nenhum participante para sortear.", "error", false);
            try {
                const randomBuffer = new Uint32Array(1);
                window.crypto.getRandomValues(randomBuffer);
                const winnerIndex = randomBuffer[0] % giv.participants.length;
                const winner = giv.participants[winnerIndex];
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', coll, id), { winner: winner, status: 'closed' });
                await saveLog("Sorteio Realizado", `Sorteou o prêmio ${giv.prize}. Vencedor: ${winner}`);
                window.notify(`Sorteio realizado! Vencedor: ${winner}`, "success", true);
            } catch (e) { console.error(e); window.notify("Erro ao processar o sorteio.", "error"); }
        };

        window.requestDeleteGiveaway = (id, isClan = false) => { 
            if(isClan) clanGiveawayToDeleteId = id; else giveawayToDeleteId = id; 
            window.openModal(isClan ? 'modal-confirm-clan-giveaway-delete' : 'modal-confirm-giveaway-delete'); 
        };
        
        window.confirmGiveawayDelete = async (isClan = false) => {
            const id = isClan ? clanGiveawayToDeleteId : giveawayToDeleteId;
            const coll = isClan ? 'clan_giveaways' : 'giveaways';
            const giv = (isClan ? allClanGiveaways : allGiveaways).find(g => g.id === id);
            if (id) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', coll, id));
                await saveLog("Exclusão de Sorteio", `Removeu o sorteio do prêmio: ${giv?.prize}`);
                window.closeModal(isClan ? 'modal-confirm-clan-giveaway-delete' : 'modal-confirm-giveaway-delete');
                window.notify("Sorteio removido.", "success", false);
            }
        };

        window.renderGiveaways = function(isClan = false) {
            const listId = isClan ? 'clan-giveaways-list' : 'giveaways-list';
            const list = document.getElementById(listId); if(!list) return;
            list.innerHTML = '';
            const dataList = isClan ? allClanGiveaways : allGiveaways;
            
            // Permissões separadas por tipo de sorteio
            const canManage = isClan ? window.hasPermission('MANAGE_CLAN_GIVEAWAYS') : window.hasPermission('MANAGE_GLOBAL_GIVEAWAYS');
            const canDelete = isClan ? window.hasPermission('DELETE_CLAN_GIVEAWAYS') : window.hasPermission('DELETE_GLOBAL_GIVEAWAYS');
            
            const visibleList = isClan && !canManage ? dataList.filter(g => g.status !== 'suggestion' || g.createdBy === currentUser?.name) : dataList;
            if (visibleList.length === 0) { list.innerHTML = `<div class="col-span-full text-center p-12 bg-white rounded-3xl border-2 border-dashed border-${isClan ? 'purple' : 'pink'}-200 text-slate-400 font-medium">Nenhum sorteio ${isClan ? 'do clã ' : ''}ativo no momento. Fique atento!</div>`; return; }
            visibleList.sort((a,b) => (a.status === 'open' ? -1 : 1) || b.createdAt - a.createdAt).forEach(g => {
                const isParticipant = currentUser && (g.participants || []).includes(currentUser.name);
                const hasWinner = g.winner !== null;
                const isSuggestion = g.status === 'suggestion';
                const pCount = (g.participants || []).length;
                const isCreator = currentUser && (g.createdBy === currentUser.name);
                let actionArea = '';
                if (isSuggestion) { 
                    if (canManage) { actionArea = `<div class="mt-6"><button onclick="window.approveClanGiveaway('${g.id}')" class="w-full py-3 rounded-xl bg-green-500 text-white font-bold shadow-lg hover:bg-green-600 transition uppercase text-xs">Aprovar Sorteio</button></div>`; } 
                    else { actionArea = `<div class="mt-6 p-3 bg-yellow-50 text-yellow-600 rounded-xl border border-yellow-100 text-center text-xs font-bold uppercase">Aguardando aprovação da Luhnny</div>`; } 
                } 
                else if (hasWinner) { actionArea = `<div class="mt-6 p-4 bg-yellow-50 rounded-2xl border-2 border-yellow-200 text-center"><p class="text-xs font-bold text-yellow-600 uppercase mb-1">O jogador que ganhou é:</p><p class="text-2xl font-extrabold text-slate-800 flex justify-center items-center gap-2"><i data-lucide="trophy" class="w-6 h-6 text-yellow-500"></i> ${g.winner}</p></div>`; } 
                else {
                    let joinBtn = currentUser && !isParticipant ? `<button onclick="window.joinGiveaway('${g.id}', ${isClan})" class="w-full py-3 rounded-xl ${isClan ? 'bg-purple-500 hover:bg-purple-600' : 'pink-gradient'} text-white font-bold shadow-lg transition active:scale-95 uppercase tracking-tighter hover:shadow-xl flex items-center justify-center gap-2"><i data-lucide="ticket"></i> Quero Participar</button>` : currentUser && isParticipant ? `<div class="w-full py-3 rounded-xl bg-green-50 text-green-600 font-bold border border-green-200 text-center flex items-center justify-center gap-2"><i data-lucide="check-circle"></i> Você está participando</div>` : `<div class="text-center text-sm text-slate-400 italic">Faça login para participar</div>`;
                    let drawBtn = (canManage || isCreator) && pCount > 0 ? `<div class="mt-3 flex gap-2"><button onclick="window.runGiveawayDraw('${g.id}', ${isClan})" class="flex-1 py-3 rounded-xl bg-slate-800 text-white font-bold shadow-lg transition active:scale-95 uppercase tracking-tighter hover:bg-slate-900 flex items-center justify-center gap-2"><i data-lucide="dices"></i> Sortear Agora</button><button onclick="window.viewParticipants('${g.id}', ${isClan})" class="px-4 py-3 rounded-xl bg-${isClan ? 'purple' : 'pink'}-100 text-${isClan ? 'purple' : 'pink'}-600 font-bold shadow-sm hover:bg-${isClan ? 'purple' : 'pink'}-200 transition"><i data-lucide="eye"></i></button></div>` : (canManage || isCreator) && pCount === 0 ? `<div class="mt-3 text-center text-xs text-slate-400 font-bold uppercase">Aguardando participantes...</div>` : canManage ? `<button onclick="window.viewParticipants('${g.id}', ${isClan})" class="w-full mt-3 px-4 py-2 rounded-xl bg-slate-100 text-slate-600 font-bold text-xs uppercase hover:bg-slate-200 transition">Ver Participantes</button>` : '';
                    actionArea = `<div class="mt-6 space-y-3">${joinBtn}${drawBtn}</div>`;
                }
                let delBtn = canDelete ? `<button onclick="window.requestDeleteGiveaway('${g.id}', ${isClan})" class="p-2 text-red-300 hover:text-red-500 transition bg-white rounded-full shadow-sm border border-slate-100"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : '';
                let editBtn = (canManage || isCreator) ? `<button onclick="window.editGiveaway('${g.id}', ${isClan})" class="p-2 text-blue-300 hover:text-blue-500 transition bg-white rounded-full shadow-sm border border-slate-100"><i data-lucide="edit-2" class="w-4 h-4"></i></button>` : '';
                let adminControls = (editBtn || delBtn) ? `<div class="absolute top-4 right-4 flex gap-2">${editBtn}${delBtn}</div>` : '';
                list.innerHTML += `<div class="relative bg-white p-8 rounded-3xl card-shadow border-2 ${hasWinner ? 'border-yellow-200' : isSuggestion ? 'border-yellow-200 border-dashed' : isClan ? 'border-purple-200' : 'border-pink-200'} flex flex-col justify-between transition hover:scale-[1.01]">${adminControls}<div><div class="flex items-center gap-2 mb-2 text-${isClan ? 'purple' : 'pink'}-500 font-bold text-xs uppercase tracking-wider"><i data-lucide="calendar" class="w-4 h-4"></i> ${g.date} às ${g.time}</div><h3 class="text-2xl font-extrabold text-slate-800 mb-1">${g.prize}</h3><p class="text-sm text-slate-500 font-medium">Sorteio organizado por ${g.createdBy}</p><div class="mt-4 flex items-center gap-2 text-sm text-slate-600 font-semibold bg-slate-50 p-2 rounded-lg inline-block"><i data-lucide="users" class="w-4 h-4 text-${isClan ? 'purple' : 'pink'}-400"></i> ${pCount} Participantes</div></div>${actionArea}</div>`;
            });
            lucide.createIcons();
        };

        window.createEventCard = function(ev, type) {
            const isP = currentUser && (ev.participants || []).includes(currentUser.name);
            const canManage = window.hasPermission('MANAGE_GLOBAL_EVENTS');
            const canDelete = window.hasPermission('DELETE_GLOBAL_EVENTS');
            let controls = '';
            const pCount = (ev.participants || []).length;
            const creditText = (ev.suggestedBy && ev.suggestedBy !== "Luhnny") ? `<div class="mb-2 text-[10px] bg-pink-50 text-pink-500 py-1 px-2 rounded-lg inline-flex items-center gap-1 font-bold uppercase"><i data-lucide="award" class="w-3 h-3"></i> Sugestão de: ${ev.suggestedBy}</div>` : '';
            const pList = `<div class="mt-4 text-slate-500 font-semibold text-left flex flex-col gap-2"><span class="text-slate-400 font-bold uppercase text-xs">Inscritos (${pCount}):</span><div class="flex flex-wrap gap-2">${pCount > 0 ? ev.participants.map(p => `<span class="group bg-pink-50 border border-pink-100 px-3 py-1.5 rounded-xl text-pink-600 text-sm font-bold shadow-sm flex items-center gap-1.5">${p}${canManage ? `<button onclick="window.removeEventParticipant('${ev.id}', '${p}', ${false})" class="text-red-400 hover:text-red-600 transition leading-none">×</button>` : ''}</span>`).join('') : '<span class="italic text-slate-300 text-sm">Ninguém inscrito</span>'}</div></div>`;
            const prizeDisplay = `<div class="text-xs"><p class="font-bold text-pink-400 uppercase mb-1 text-[10px]">Prêmios:</p><p class="font-medium text-slate-600">🥇 ${ev.prizes?.[0] || '?'} | 🥈 ${ev.prizes?.[1] || '?'} | 🥉 ${ev.prizes?.[2] || '?'}</p></div>`;
            if (canManage) {
                let deleteControl = canDelete ? `<button onclick="window.requestDeleteEvent('${ev.id}')" class="${type === 'suggestion' ? 'text-[10px] bg-red-100 text-red-600 px-3 py-1 rounded-lg' : 'p-1 text-red-300'}">${type === 'suggestion' ? 'Rejeitar' : '<i data-lucide="trash-2" class="w-4 h-4"></i>'}</button>` : '';
                if (type === 'suggestion') controls = `<div class="mt-4 flex gap-2 border-t pt-4"><button onclick="window.approveClanEvent('${ev.id}')" class="text-[10px] bg-green-500 text-white px-3 py-1 rounded-lg font-bold">Aprovar</button><button onclick="window.editClanEvent('${ev.id}')" class="text-[10px] bg-blue-100 text-blue-600 px-3 py-1 rounded-lg font-bold">Editar</button>${deleteControl}</div>`;
                else controls = `<div class="mt-4 flex flex-wrap gap-2 border-t pt-4"><button onclick="window.editClanEvent('${ev.id}')" class="text-[10px] bg-pink-100 text-pink-600 px-3 py-1 rounded-lg font-bold">Editar</button><button onclick="window.updateClanEventStatus('${ev.id}', '${ev.status}')" class="text-[10px] bg-slate-800 text-white px-3 py-1 rounded-lg">${ev.status === 'active' ? 'Encerrar' : 'Reativar'}</button>${deleteControl}</div>${pList}`;
            } else if (currentUser && !currentUser.isAlly && (type === 'active' || type === 'history')) { controls = pList; }
            return `<div class="bg-white rounded-3xl card-shadow border-2 ${type === 'active' ? 'border-pink-200' : type === 'suggestion' ? 'border-yellow-200 border-dashed' : 'border-slate-200 opacity-75'} p-6 mb-6 max-w-4xl mx-auto text-left transition-transform hover:scale-[1.01]"><div class="flex justify-between items-start mb-1"><h3 class="text-xl font-bold ${type === 'active' ? 'text-pink-600' : 'text-slate-600'}">${ev.title}</h3><span class="px-3 py-1 rounded-full text-[10px] font-bold uppercase ${type === 'active' ? 'bg-green-100 text-green-600' : type === 'suggestion' ? 'bg-yellow-100 text-yellow-600' : 'bg-slate-100 text-slate-500'}">${type === 'active' ? 'Ativo' : type === 'suggestion' ? 'Pendente' : 'Encerrado'}</span></div>${creditText}<div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm mb-6 mt-4"><div class="space-y-2"><p class="flex items-center gap-2 font-medium text-slate-600"><i data-lucide="calendar" class="w-4 h-4 text-pink-300"></i> ${ev.date}</p><p class="flex items-center gap-2 font-medium text-slate-600"><i data-lucide="clock" class="w-4 h-4 text-pink-300"></i> ${ev.time || 'A definir'}</p><p class="flex items-center gap-2 font-medium text-slate-600"><i data-lucide="map-pin" class="w-4 h-4 text-pink-300"></i> ${ev.location}</p></div><div class="space-y-2">${prizeDisplay}</div></div><div class="mb-6 p-4 bg-slate-50 rounded-xl text-xs text-slate-500 italic border border-slate-100"><strong>Sobre:</strong> ${ev.rules}</div>${type === 'active' && currentUser && !currentUser.isAlly ? `<button onclick="window.toggleClanParticipation('${ev.id}')" class="w-full py-3 rounded-2xl font-bold transition-all flex items-center justify-center gap-2 ${isP ? 'bg-red-50 text-red-500' : 'pink-gradient text-white hover:shadow-lg active:scale-95'}"><i data-lucide="${isP ? 'x-circle' : 'user-plus'}"></i> ${isP ? 'Cancelar Participação' : 'Quero Participar'}</button>` : ''}${controls}</div>`;
        };

        window.renderEvents = function() {
            const actC = document.getElementById('active-events-list'); const histC = document.getElementById('history-events-list'); const suggC = document.getElementById('suggested-events-list'); const suggS = document.getElementById('suggestions-section');
            if(!actC) return; actC.innerHTML = ''; if(histC) histC.innerHTML = ''; if(suggC) suggC.innerHTML = '';
            const actives = allEvents.filter(e => e.status === 'active'); const history = allEvents.filter(e => e.status === 'ended'); const suggestions = allEvents.filter(e => e.status === 'suggestion');
            const canManage = window.hasPermission('MANAGE_GLOBAL_EVENTS');
            if (canManage && suggestions.length > 0) { suggS?.classList.remove('hidden'); suggestions.forEach(ev => suggC.innerHTML += window.createEventCard(ev, 'suggestion')); } else suggS?.classList.add('hidden');
            if (actives.length === 0) document.getElementById('no-active-message')?.classList.remove('hidden'); else { document.getElementById('no-active-message')?.classList.add('hidden'); actives.forEach(ev => actC.innerHTML += window.createEventCard(ev, 'active')); }
            if(histC) history.forEach(ev => histC.innerHTML += window.createEventCard(ev, 'history'));
            lucide.createIcons();
        };

        window.createClanEventCard = function(ev, type) {
            const isP = currentUser && (ev.participants || []).includes(currentUser.name);
            const canManage = window.hasPermission('MANAGE_CLAN_EVENTS');
            const canDelete = window.hasPermission('DELETE_CLAN_EVENTS');
            let controls = ''; 
            const pCount = (ev.participants || []).length;
            const creditText = (ev.suggestedBy && ev.suggestedBy !== 'Luhnny') ? `<div class="mb-2 text-[10px] font-bold bg-pink-50 text-pink-500 py-1 px-2 rounded-lg inline-flex items-center gap-1 uppercase"><i data-lucide="award" class="w-3 h-3"></i> Sugestão de: ${ev.suggestedBy}</div>` : '';
            const pList = `<div class="mt-4 text-slate-500 font-semibold text-left flex flex-col gap-2"><span class="text-slate-400 font-bold uppercase text-xs">Inscritos (${pCount}):</span><div class="flex flex-wrap gap-2">${pCount > 0 ? ev.participants.map(p => `<span class="group bg-pink-50 border border-pink-100 px-3 py-1.5 rounded-xl text-pink-600 text-sm font-bold shadow-sm flex items-center gap-1.5">${p}${canManage ? `<button onclick="window.removeEventParticipant('${ev.id}', '${p}', ${true})" class="text-red-400 hover:text-red-600 transition leading-none">×</button>` : ''}</span>`).join('') : '<span class="italic text-slate-300 text-sm">Ninguém inscrito</span>'}</div></div>`;
            const prizeDisplay = `<div class="text-xs"><p class="font-bold text-pink-400 uppercase mb-1 text-[10px]">Prêmios:</p><p class="font-medium text-slate-600">🥇 ${ev.prizes?.[0] || '?'} | 🥈 ${ev.prizes?.[1] || '?'} | 🥉 ${ev.prizes?.[2] || '?'}</p></div>`;
            if (canManage) {
                let deleteControl = canDelete ? `<button onclick="window.deleteClanEvent('${ev.id}')" class="${type === 'suggestion' ? 'text-[10px] bg-red-100 text-red-600 px-3 py-1 rounded-lg' : 'p-1 text-red-300'}"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : '';
                if (type === 'suggestion') controls = `<div class="mt-4 flex gap-2 border-t pt-4"><button onclick="window.approveClanEventInternal('${ev.id}')" class="text-[10px] bg-green-500 text-white px-3 py-1 rounded-lg font-bold">Aprovar</button><button onclick="window.editClanEventInternal('${ev.id}')" class="text-[10px] bg-blue-100 text-blue-600 px-3 py-1 rounded-lg font-bold">Editar</button>${canDelete ? `<button onclick="window.deleteClanEvent('${ev.id}')" class="text-[10px] bg-red-100 text-red-600 px-3 py-1 rounded-lg">Rejeitar</button>` : ''}</div>`;
                else controls = `<div class="mt-4 flex flex-wrap gap-2 border-t pt-4"><button onclick="window.editClanEventInternal('${ev.id}')" class="text-[10px] bg-pink-100 text-pink-600 px-3 py-1 rounded-lg font-bold">Editar</button><button onclick="window.updateClanEventStatusInternal('${ev.id}', '${ev.status}')" class="text-[10px] bg-slate-800 text-white px-3 py-1 rounded-lg">${ev.status === 'active' ? 'Encerrar' : 'Reativar'}</button>${deleteControl}</div>${pList}`;
            } else { controls = pList; }
            return `<div class="bg-white rounded-3xl card-shadow border-2 ${type === 'active' ? 'border-pink-200' : type === 'suggestion' ? 'border-yellow-200 border-dashed' : 'border-slate-200 opacity-75'} p-6 mb-6 max-w-4xl mx-auto text-left transition-transform hover:scale-[1.01]"><div class="flex justify-between items-start mb-1"><h3 class="text-xl font-bold ${type === 'active' ? 'text-pink-600' : 'text-slate-600'}">${ev.title}</h3><span class="px-3 py-1 rounded-full text-[10px] font-bold uppercase ${type === 'active' ? 'bg-green-100 text-green-600' : type === 'suggestion' ? 'bg-yellow-100 text-yellow-600' : 'bg-slate-100 text-slate-500'}">${type === 'active' ? 'Ativo' : type === 'suggestion' ? 'Pendente' : 'Encerrado'}</span></div>${creditText}<div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm mb-6 mt-4"><div class="space-y-2"><p class="flex items-center gap-2 font-medium text-slate-600"><i data-lucide="calendar" class="w-4 h-4 text-pink-300"></i> ${ev.date}</p><p class="flex items-center gap-2 font-medium text-slate-600"><i data-lucide="clock" class="w-4 h-4 text-pink-300"></i> ${ev.time || 'A definir'}</p><p class="flex items-center gap-2 font-medium text-slate-600"><i data-lucide="map-pin" class="w-4 h-4 text-pink-300"></i> ${ev.location}</p></div><div class="space-y-2">${prizeDisplay}<div class="text-xs"><p class="font-bold text-pink-400 uppercase mb-1 text-[10px]">Tema:</p><p class="font-medium text-slate-600">${ev.theme}</p></div></div></div><div class="mb-6 p-4 bg-slate-50 rounded-xl text-xs text-slate-500 italic border border-slate-100"><strong>Sobre:</strong> ${ev.rules}</div>${type === 'active' && currentUser && !currentUser.isAlly ? `<button onclick="window.toggleClanEventJoin('${ev.id}')" class="w-full py-3 rounded-2xl font-bold transition-all flex items-center justify-center gap-2 ${isP ? 'bg-red-50 text-red-500' : 'pink-gradient text-white hover:shadow-lg active:scale-95'}"><i data-lucide="${isP ? 'x-circle' : 'user-plus'}"></i> ${isP ? 'Cancelar Participação' : 'Quero Participar'}</button>` : ''}${controls}</div>`;
        };

        window.renderClanEvents = function() {
            const actC = document.getElementById('clan-active-events-list'); const histC = document.getElementById('clan-history-events-list'); const suggC = document.getElementById('clan-suggested-events-list'); const suggS = document.getElementById('clan-suggestions-section');
            if(!actC) return; actC.innerHTML = ''; if(histC) histC.innerHTML = ''; if(suggC) suggC.innerHTML = '';
            const actives = allClanEvents.filter(e => e.status === 'active'); const history = allClanEvents.filter(e => e.status === 'ended'); const suggestions = allClanEvents.filter(e => e.status === 'suggestion');
            const canManage = window.hasPermission('MANAGE_CLAN_EVENTS');
            if (canManage && suggestions.length > 0) { suggS?.classList.remove('hidden'); suggestions.forEach(ev => suggC.innerHTML += window.createClanEventCard(ev, 'suggestion')); } else suggS?.classList.add('hidden');
            if (actives.length === 0) document.getElementById('clan-no-active-message')?.classList.remove('hidden'); else { document.getElementById('clan-no-active-message')?.classList.add('hidden'); actives.forEach(ev => actC.innerHTML += window.createClanEventCard(ev, 'active')); }
            if(histC) history.forEach(ev => histC.innerHTML += window.createClanEventCard(ev, 'history'));
            lucide.createIcons();
        };

        window.publishClanEventData = async () => {
            const canManage = window.hasPermission('MANAGE_CLAN_EVENTS');
            const data = { title: document.getElementById('clan-ev-title').value, theme: document.getElementById('clan-ev-theme').value, date: document.getElementById('clan-ev-date').value, time: document.getElementById('clan-ev-time').value, location: document.getElementById('clan-ev-loc').value || "Servidor bawMC", prizes: [document.getElementById('clan-ev-p1').value, document.getElementById('clan-ev-p2').value, document.getElementById('clan-ev-p3').value], rules: document.getElementById('clan-ev-rules').value, status: canManage ? 'active' : 'suggestion', suggestedBy: (editingClanEventId && editingClanEventAuthor) ? editingClanEventAuthor : currentUser.name, participants: [], createdAt: Date.now() };
            if (editingClanEventId) {
                if (canManage) data.status = 'active'; const oldEvent = allClanEvents.find(e => e.id === editingClanEventId); if (oldEvent && oldEvent.participants) data.participants = oldEvent.participants;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'clan_events', editingClanEventId), data); 
                await saveLog("Edição de Evento (Clã)", `Editou evento: ${data.title}`);
                editingClanEventId = null; editingClanEventAuthor = null;
            } else { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'clan_events'), data); await saveLog(canManage ? "Criação de Evento (Clã)" : "Sugestão de Evento (Clã)", `Evento: ${data.title}`); }
            window.closeModal('modal-clan-event'); window.notify(canManage ? "Evento do Clã Publicado!" : "Sugestão enviada para Luhnny!", "success", false);
        };
        
        window.approveClanEventInternal = async (id) => { const ev = allClanEvents.find(e => e.id === id); await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'clan_events', id), { status: 'active' }); await saveLog("Aprovação de Evento (Clã)", `Aprovou evento: ${ev?.title}`); window.notify("Evento do Clã aprovado!", "success", false); };
        window.updateClanEventStatusInternal = async (id, current) => { const next = current === 'active' ? 'ended' : 'active'; await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'clan_events', id), { status: next }); };
        window.toggleClanEventJoin = async (id) => { const ev = allClanEvents.find(e => e.id === id); const p = ev.participants || []; const next = p.includes(currentUser.name) ? p.filter(x => x !== currentUser.name) : [...p, currentUser.name]; await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'clan_events', id), { participants: next }); };
        window.deleteClanEvent = async (id) => { const ev = allClanEvents.find(e => e.id === id); await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'clan_events', id)); await saveLog("Exclusão de Evento (Clã)", `Removeu o evento: ${ev?.title}`); };
        window.editClanEventInternal = (id) => { const ev = allClanEvents.find(e => e.id === id); if(!ev) return; editingClanEventId = id; editingClanEventAuthor = ev.suggestedBy; document.getElementById('clan-ev-title').value = ev.title; document.getElementById('clan-ev-theme').value = ev.theme; document.getElementById('clan-ev-date').value = ev.date; document.getElementById('clan-ev-time').value = ev.time || ''; document.getElementById('clan-ev-loc').value = ev.location; document.getElementById('clan-ev-p1').value = ev.prizes?.[0] || ''; document.getElementById('clan-ev-p2').value = ev.prizes?.[1] || ''; document.getElementById('clan-ev-p3').value = ev.prizes?.[2] || ''; document.getElementById('clan-ev-rules').value = ev.rules; window.openModal('modal-clan-event'); };
        window.openCreateClanEventModal = () => { editingClanEventId = null; editingClanEventAuthor = null; document.getElementById('modal-clan-event-form').reset(); window.openModal('modal-clan-event'); };

        window.publishClanEvent = async () => {
            const canManage = window.hasPermission('MANAGE_GLOBAL_EVENTS');
            const data = { title: document.getElementById('ev-title').value, theme: document.getElementById('ev-theme').value, date: document.getElementById('ev-date').value, time: document.getElementById('ev-time').value, location: document.getElementById('ev-loc').value || "Servidor bawMC", prizes: [document.getElementById('ev-p1').value, document.getElementById('ev-p2').value, document.getElementById('ev-p3').value], rules: document.getElementById('ev-rules').value, status: canManage ? 'active' : 'suggestion', suggestedBy: (editingEventId && editingEventAuthor) ? editingEventAuthor : currentUser.name, participants: [], createdAt: Date.now() };
            if (editingEventId) {
                if (canManage) data.status = 'active'; const oldEvent = allEvents.find(e => e.id === editingEventId); if (oldEvent && oldEvent.participants) data.participants = oldEvent.participants;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'events', editingEventId), data); 
                await saveLog("Edição de Evento (Global)", `Editou evento: ${data.title}`);
                editingEventId = null; editingEventAuthor = null;
            } else { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'events'), data); await saveLog(canManage ? "Criação de Evento (Global)" : "Sugestão de Evento (Global)", `Evento: ${data.title}`); }
            window.closeModal('modal-admin-event'); window.notify(canManage ? "Evento Publicado!" : "Sugestão enviada para Luhnny!", "success", false);
        };

        window.approveClanEvent = async (id) => { const ev = allEvents.find(e => e.id === id); await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'events', id), { status: 'active' }); await saveLog("Aprovação de Evento (Global)", `Aprovou evento: ${ev?.title}`); window.notify("Evento aprovado!", "success", false); };
        window.updateClanEventStatus = async (id, current) => { const next = current === 'active' ? 'ended' : 'active'; await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'events', id), { status: next }); };
        window.toggleClanParticipation = async (id) => { const ev = allEvents.find(e => e.id === id); const p = ev.participants || []; const next = p.includes(currentUser.name) ? p.filter(x => x !== currentUser.name) : [...p, currentUser.name]; await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'events', id), { participants: next }); };
        window.requestDeleteEvent = (id) => { eventToDeleteId = id; window.openModal('modal-confirm-delete'); };
        window.confirmDelete = async () => { const ev = allEvents.find(e => e.id === eventToDeleteId); await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'events', eventToDeleteId)); await saveLog("Exclusão de Evento (Global)", `Removeu o evento: ${ev?.title}`); window.closeModal('modal-confirm-delete'); };
        window.editClanEvent = (id) => { const ev = allEvents.find(e => e.id === id); if(!ev) return; editingEventId = id; editingEventAuthor = ev.suggestedBy; document.getElementById('ev-title').value = ev.title; document.getElementById('ev-theme').value = ev.theme; document.getElementById('ev-date').value = ev.date; document.getElementById('ev-time').value = ev.time || ''; document.getElementById('ev-loc').value = ev.location; document.getElementById('ev-p1').value = ev.prizes?.[0] || ''; document.getElementById('ev-p2').value = ev.prizes?.[1] || ''; document.getElementById('ev-p3').value = ev.prizes?.[2] || ''; document.getElementById('ev-rules').value = ev.rules; window.openModal('modal-admin-event'); };

        window.publishClanAlliance = async () => { const name = document.getElementById('ali-name').value; const tag = document.getElementById('ali-tag').value; const canManageAlliances = window.hasPermission('MANAGE_ALLIANCES'); if(canManageAlliances) { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'alliances'), { name, tag, members: [], createdAt: Date.now() }); await saveLog("Nova Aliança", `Criou aliança com clã ${name}`); window.notify("Aliança criada!", "success", false); } else { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'alliance_requests'), { name, tag, requestedBy: currentUser.name, createdAt: Date.now() }); await saveLog("Pedido de Aliança", `Sugeriu aliança com clã ${name}`); window.notify("Solicitação enviada!", "success", false); } window.closeModal('modal-admin-alliance'); };
        window.approveAllianceRequest = async (id, d) => { if (!window.hasPermission('MANAGE_ALLIANCES')) return; await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'alliances'), { name: d.name, tag: d.tag, members: [], createdAt: Date.now() }); await saveLog("Aprovação de Aliança", `Aprovou pedido de aliança do clã ${d.name}`); await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'alliance_requests', id)); };
        window.rejectAllianceRequest = async (id) => { if (!window.hasPermission('MANAGE_ALLIANCES')) return; const r = allAllianceRequests.find(x => x.id === id); await saveLog("Recusa de Aliança", `Recusou pedido de aliança do clã ${r?.name}`); await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'alliance_requests', id)); };
        window.removeAllyMember = async (id, n) => { const a = allAlliances.find(x => x.id === id); if(a) { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'alliances', id), { members: a.members.filter(x => x !== n) }); await saveLog("Remoção de Aliado", `Removeu ${n} do clã aliado ${a.name}`); } };
        window.deleteIdentity = async (n) => { try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ally_identities', n)); await saveLog("Exclusão de Vínculo", `Removeu vínculo de identidade de: ${n}`); window.notify("Vínculo removido.", "info", false); } catch (e) { console.error("Erro ao deletar:", e); window.notify("Erro ao remover: " + e.message, "error", false); } };
        window.requestDeleteAlliance = (id) => { allianceToDeleteId = id; window.openModal('modal-confirm-alliance-delete'); };
        window.confirmAllianceDelete = async () => { if (!allianceToDeleteId) return; const ali = allAlliances.find(a => a.id === allianceToDeleteId); await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'alliances', allianceToDeleteId)); await saveLog("Exclusão de Aliança", `Encerrou aliança com clã ${ali?.name}`); window.closeModal('modal-confirm-alliance-delete'); };

        window.renderIdentities = function() {
            const canManage = window.hasPermission('MANAGE_MEMBERS'); 
            const allyIdenC = document.getElementById('ally-identities-section'); 
            const allyIdenL = document.getElementById('ally-identities-list'); 
            const memIdenC = document.getElementById('member-identities-section'); 
            const memIdenL = document.getElementById('member-identities-list');
            const isLuhnny = currentUser && currentUser.name === "Luhnny";
            
            if (!canManage) { 
                if(allyIdenC) allyIdenC.classList.add('hidden'); 
                if(memIdenC) memIdenC.classList.add('hidden'); 
                return; 
            }

            // Unifica as contas reais (do users) e identidades para garantir que Luhnny veja todos para resetar
            const accounts = [...allUsers];
            allIdentities.forEach(iden => {
                if (!accounts.find(acc => (acc.name || "").toLowerCase() === iden.id.toLowerCase())) {
                    accounts.push({ name: iden.nick, role: iden.role || 'ally' });
                }
            });

            const members = accounts.filter(i => { 
                const nickLower = (i.name || i.nick || "").toLowerCase(); 
                return i.role === 'member' || ALLOWED_MEMBERS.some(m => m.toLowerCase() === nickLower) || allAuthorizedMembers.some(m => m.nick.toLowerCase() === nickLower) || allDynamicAllowedMembers.some(m => m.nick.toLowerCase() === nickLower); 
            });
            const allies = accounts.filter(i => !members.some(m => (m.name || m.nick || "").toLowerCase() === (i.name || i.nick || "").toLowerCase()));

            const createIdenCard = (i) => {
                const name = i.name || i.nick;
                return `<div class="bg-slate-50 p-3 rounded-xl border border-slate-200 flex items-center justify-between"><span class="text-xs font-bold text-slate-600">${name || 'Desconhecido'}</span><div class="flex gap-1">${isLuhnny ? `<button title="Resetar Senha" onclick="window.requestResetAccount('${name}')" class="text-pink-400 hover:text-pink-600 transition"><i data-lucide="key" class="w-4 h-4"></i></button>`:''}<button onclick="window.deleteIdentity('${(name||'').toLowerCase()}')" class="text-red-400 hover:text-red-600 transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></div>`;
            };

            if (allyIdenC && allyIdenL) { 
                allyIdenC.classList.remove('hidden'); 
                allyIdenL.innerHTML = allies.length === 0 ? '<p class="text-slate-400 text-xs italic col-span-full">Nenhum aliado vinculado.</p>' : allies.map(createIdenCard).join(''); 
            }
            if (memIdenC && memIdenL) { 
                memIdenC.classList.remove('hidden'); 
                memIdenL.innerHTML = members.length === 0 ? '<p class="text-slate-400 text-xs italic col-span-full">Nenhum membro vinculado.</p>' : members.map(createIdenCard).join(''); 
            }
            lucide.createIcons();
        };

        window.renderAlliances = function() {
            const c = document.getElementById('alliances-list'); if (!c) return; const reqC = document.getElementById('alliance-requests-section'); const reqL = document.getElementById('alliance-requests-list'); const canManageAlliances = window.hasPermission('MANAGE_ALLIANCES'); c.innerHTML = '';
            const isLuhnny = currentUser?.name === "Luhnny";
            if (allAlliances.length === 0) { c.innerHTML = `<div class="bg-white p-6 rounded-3xl card-shadow border-2 border-pink-100 flex items-center justify-between"><div><h4 class="text-xl font-bold">C0RV0S</h4><span class="text-pink-400 font-bold uppercase text-sm">CR0W</span></div><div class="p-3 bg-pink-50 rounded-full text-pink-400"><i data-lucide="shield-check"></i></div></div><div class="bg-white p-6 rounded-3xl card-shadow border-2 border-pink-100 flex items-center justify-between"><div><h4 class="text-xl font-bold">Tenebris</h4><span class="text-pink-400 font-bold uppercase text-sm">TNB</span></div><div class="p-3 bg-pink-50 rounded-full text-pink-400"><i data-lucide="shield-check"></i></div></div>`; } 
            else { allAlliances.forEach(a => { const m = (a.members || []).map(nick => `<span class="bg-slate-50 px-2 py-1 rounded text-[10px] font-bold border flex items-center gap-1">${nick}${canManageAlliances ? `<button onclick="window.removeAllyMember('${a.id}','${nick}')" class="text-red-400">×</button>`:''}</span>`).join(''); c.innerHTML += `<div class="bg-white p-6 rounded-3xl card-shadow border-2 border-pink-100 flex flex-col transition-all hover:scale-[1.02]"><div class="flex items-center justify-between"><div><h4 class="text-xl font-bold">${a.name}</h4><span class="text-pink-400 font-bold uppercase text-sm">${a.tag}</span></div><div class="flex gap-2">${isLuhnny ? `<button onclick="window.requestDeleteAlliance('${a.id}')" class="text-red-300"><i data-lucide="trash-2"></i></button>`:''}<div class="p-3 bg-pink-50 rounded-full text-pink-400"><i data-lucide="shield-check"></i></div></div></div><div class="mt-4 border-t pt-2 flex flex-wrap gap-1">${m}</div></div>`; }); }
            if (canManageAlliances && allAllianceRequests.length > 0) { reqC.classList.remove('hidden'); reqL.innerHTML = ''; allAllianceRequests.forEach(r => { reqL.innerHTML += `<div class="bg-yellow-50 p-4 rounded-2xl border-2 border-yellow-100 flex items-center justify-between shadow-sm"><div class="text-left"><h5 class="font-bold text-slate-800">${r.name}</h5><p class="text-[10px] text-yellow-600 font-bold">De: ${r.requestedBy}</p></div><div class="flex gap-2"><button onclick='window.approveAllianceRequest("${r.id}", ${JSON.stringify(r)})' class="bg-green-500 text-white p-2 rounded-lg"><i data-lucide="check" class="w-4 h-4"></i></button><button onclick="window.rejectAllianceRequest('${r.id}')" class="bg-red-500 text-white p-2 rounded-lg"><i data-lucide="x" class="w-4 h-4"></i></button></div></div>`; }); } else reqC?.classList.add('hidden');
        };

        window.requestRecruitmentReview = async () => {
            if (!isRecruitmentOpen) return window.notify("O recrutamento está fechado!", "error");
            const nick = document.getElementById('rec-nick').value.trim();
            const discord = document.getElementById('rec-discord').value.trim();
            const idade = document.getElementById('rec-idade').value;
            const tempo = document.getElementById('rec-tempo').value;
            if (!nick || !discord || !idade || !tempo) return window.notify("Preencha os campos obrigatórios!", "error");
            try {
                const docRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'recruitment'), { nick, discord, idade, tempo, voice: document.getElementById('rec-voice').value, clas: document.getElementById('rec-clas').value, combate: document.getElementById('rec-combate').value, build: document.getElementById('rec-build').value, farm: document.getElementById('rec-farm').value, plataforma: document.getElementById('rec-plat').value, rank: document.getElementById('rec-rank').value, aniversario: document.getElementById('rec-aniv').value, horarios: document.getElementById('rec-horarios').value, status: 'pendente', createdAt: Date.now() });
                localStorage.setItem('afk_recruitment_id', docRef.id);
                localStorage.setItem('afk_last_submission_date', new Date().toDateString());
                window.notify("Formulário enviado com sucesso!", "success");
                document.getElementById('form-recruitment').reset();
                window.renderMyRecruitmentStatus();
            } catch (e) { console.error(e); window.notify("Erro ao enviar formulário.", "error"); }
        };

        window.updateApplicationStatus = async (id, status) => { 
            if (!window.hasPermission('MANAGE_RECRUITMENT')) return; 
            const appData = allApplications.find(a => a.id === id);
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'recruitment', id), { status: status, handledBy: currentUser.name }); 
            await saveLog("Recrutamento", `${status.toUpperCase()} recrutamento de ${appData?.nick}`);
            window.notify(`Pedido ${status}!`, "success", false); 
        };
        window.requestDeleteApplication = (id, status) => { applicationToDeleteId = id; applicationToDeleteStatus = status; window.openModal('modal-confirm-rec-delete'); };
        
        window.confirmRecDelete = async () => { 
            if (!applicationToDeleteId) return; 
            const appData = allApplications.find(a => a.id === applicationToDeleteId);
            if (applicationToDeleteStatus === 'aprovado') { 
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'recruitment', applicationToDeleteId), { archived: true }); 
                await saveLog("Arquivamento de Recrutamento", `Arquivou candidatura de ${appData?.nick}`);
                window.notify("Candidatura arquivada!", "success", false); 
            } else { 
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'recruitment', applicationToDeleteId)); 
                await saveLog("Exclusão de Recrutamento", `Removeu permanentemente candidatura de ${appData?.nick}`);
                window.notify("Candidatura removida!", "success", false); 
            } 
            window.closeModal('modal-confirm-rec-delete'); 
        };

        window.toggleRecruitmentStatus = async () => { if (!window.hasPermission('MANAGE_RECRUITMENT')) return; const newStatus = !isRecruitmentOpen; await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'recruitment'), { isOpen: newStatus }); await saveLog("Configuração", `${newStatus ? 'Abriu' : 'Fechou'} o recrutamento.`); };
        
        window.renderAdminApplications = function() {
            const c = document.getElementById('admin-applications-list'); if(!c || !window.hasPermission('MANAGE_RECRUITMENT')) return;
            c.innerHTML = ''; const visibleApps = allApplications.filter(app => !app.archived);
            if (visibleApps.length === 0) { c.innerHTML = '<p class="text-center text-slate-400 italic col-span-full py-10">Nenhum pedido ativo.</p>'; } 
            else { 
                visibleApps.sort((a,b)=>b.createdAt-a.createdAt).forEach(app => { 
                    const colors = { aprovado: 'bg-green-100 text-green-700', negado: 'bg-red-100 text-red-700', pendente: 'bg-yellow-100 text-yellow-700' }; 
                    const decisor = app.handledBy ? `<div class="mt-4 pt-2 border-t text-[11px] font-bold text-pink-500 uppercase">Decidido por: ${app.handledBy}</div>` : ''; 
                    c.innerHTML += `
                    <div class="bg-white p-6 rounded-2xl border-2 border-slate-100 card-shadow text-left leading-snug">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-xl font-bold text-pink-600">${app.nick}</h4>
                            <span class="px-3 py-1 rounded-full text-[10px] font-bold uppercase ${colors[app.status]}">${app.status}</span>
                        </div>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-[11px] text-slate-600 mb-4 leading-tight">
                            <p><strong>Discord:</strong> ${app.discord || '-'}</p>
                            <p><strong>Idade:</strong> ${app.idade}</p>
                            <p><strong>Tempo:</strong> ${app.tempo}h</p>
                            <p><strong>Rank:</strong> ${app.rank || '-'}</p>
                            <p><strong>PC/Mob:</strong> ${app.plataforma}</p>
                            <p><strong>Voice:</strong> ${app.voice}</p>
                            <p><strong>Combate:</strong> ${app.combate}</p>
                            <p><strong>Build:</strong> ${app.build}</p>
                            <p><strong>Farm:</strong> ${app.farm}</p>
                            <p><strong>Aniv:</strong> ${app.aniversario || '-'}</p>
                            <p class="col-span-2"><strong>Clãs Antigos:</strong> ${app.clas || '-'}</p>
                            <p class="col-span-2 italic mt-1 text-slate-400"><strong>Horários:</strong> ${app.horarios || '-'}</p>
                        </div>
                        <div class="flex gap-2 border-t pt-4">
                            <button onclick="window.updateApplicationStatus('${app.id}','aprovado')" class="flex-1 bg-green-500 text-white py-2 rounded-lg font-bold text-sm">APROVAR</button>
                            <button onclick="window.updateApplicationStatus('${app.id}','negado')" class="flex-1 bg-red-500 text-white py-2 rounded-lg font-bold text-sm">NEGAR</button>
                            <button onclick="window.requestDeleteApplication('${app.id}', '${app.status}')" class="p-2 bg-slate-50 text-slate-300 hover:text-red-500 rounded-lg transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                        ${decisor}
                    </div>`; 
                }); 
            } 
            lucide.createIcons();
        };

        window.renderMyRecruitmentStatus = function() {
            const localId = localStorage.getItem('afk_recruitment_id'); const statusContainer = document.getElementById('my-recruitment-status');
            if (!statusContainer) return; if (!localId) { statusContainer.innerHTML = ''; return; }
            if (initialRecruitmentListLoad) { statusContainer.innerHTML = '<div class="mb-10 text-slate-400 italic text-sm">Verificando status...</div>'; return; }
            
            let myApp = allApplications.find(a => a.id === localId);
            
            // CORREÇÃO: Se existe o ID no local mas não foi encontrado no banco (porque Luhnny apagou), 
            // assumimos que a decisão final foi 'negado', a menos que o doc ainda exista com outro status.
            let displayStatus = myApp ? myApp.status : 'negado'; 
            let displayNick = myApp ? myApp.nick : 'Candidato'; 
            let displayHandledBy = myApp ? myApp.handledBy : null;
            
            const colors = { aprovado: 'bg-green-50 border-green-200 text-green-600', negado: 'bg-red-50 border-red-200 text-red-600', pendente: 'bg-yellow-50 border-yellow-200 text-yellow-600' };
            const icon = { aprovado: 'check-circle', negado: 'x-circle', pendente: 'clock' };
            const msg = { aprovado: 'Parabéns! Foste aceito no Clã AFK!', negado: 'Infelizmente sua candidatura não foi aceita desta vez.', pendente: 'A tua candidatura está em análise. Aguarda!' };
            
            const statusClass = colors[displayStatus] || colors['pendente']; const statusIcon = icon[displayStatus] || 'clock'; const statusMsg = msg[displayStatus] || 'Status desconhecido';
            statusContainer.innerHTML = `<div class="mb-10 p-8 rounded-3xl border-2 text-center ${statusClass} shadow-lg transform transition-all"><div class="flex justify-center mb-4"><i data-lucide="${statusIcon}" class="w-12 h-12"></i></div><h3 class="text-2xl font-extrabold uppercase mb-2 tracking-tighter">${displayStatus.toUpperCase()}</h3><p class="font-medium text-lg opacity-90 leading-tight">${statusMsg}</p><p class="mt-4 text-xs font-bold opacity-60 uppercase">Nick: ${displayNick}</p>${displayHandledBy ? `<p class="mt-1 text-[10px] font-bold opacity-50 uppercase">Analisado por: ${displayHandledBy}</p>` : ''}</div>`; lucide.createIcons();
        };

        window.renderLogs = function() {
            const list = document.getElementById('logs-list'); if(!list) return;
            list.innerHTML = '';
            const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
            const recentLogs = allLogs.filter(log => log.timestamp >= sevenDaysAgo);
            if (recentLogs.length === 0) { list.innerHTML = '<div class="text-center p-12 text-slate-400 italic">Nenhuma ação registrada nos últimos 7 dias.</div>'; return; }
            recentLogs.sort((a,b) => b.timestamp - a.timestamp).forEach(log => {
                const date = new Date(log.timestamp).toLocaleString('pt-PT');
                list.innerHTML += `<div class="bg-white p-4 rounded-2xl border border-slate-100 flex flex-col md:flex-row md:items-center gap-4 transition hover:bg-pink-50/30"><div class="text-xs font-mono text-slate-400 whitespace-nowrap">${date}</div><div class="flex-shrink-0"><span class="px-3 py-1 bg-pink-100 text-pink-600 rounded-lg text-[10px] font-bold uppercase">${log.action}</span></div><div class="flex-grow"><strong class="text-slate-700">${log.user}</strong> <span class="text-slate-500 text-sm">${log.details}</span></div></div>`;
            });
        };

        window.updateUI = function() {
            const canAccessMgmt = window.hasPermission('ACCESS_MGMT_TAB');
            const canManageRec = window.hasPermission('MANAGE_RECRUITMENT');
            const canManageAlliances = window.hasPermission('MANAGE_ALLIANCES');
            const canManageGlobalEvents = window.hasPermission('MANAGE_GLOBAL_EVENTS');
            const canManageClanEvents = window.hasPermission('MANAGE_CLAN_EVENTS');
            const canManageMissions = window.hasPermission('MANAGE_MISSIONS');
            const canManageGlobalGiv = window.hasPermission('MANAGE_GLOBAL_GIVEAWAYS');
            const canManageClanGiv = window.hasPermission('MANAGE_CLAN_GIVEAWAYS');
            const canManageMembers = window.hasPermission('MANAGE_MEMBERS');
            
            const btnGerenciamento = document.getElementById('btn-gerenciamento');
            if (canAccessMgmt) btnGerenciamento?.classList.remove('hidden'); else btnGerenciamento?.classList.add('hidden');
            
            const aRecPanel = document.getElementById('admin-recruitment-section'); 
            const aAllyBtn = document.getElementById('admin-alliance-panel'); 
            const lBtn = document.getElementById('btn-login-trigger'); 
            const uDisp = document.getElementById('user-logged-in'); 
            const aEventBtn = document.getElementById('admin-event-panel'); 
            const aMissionAdmin = document.getElementById('admin-mission-controls'); 
            const aGiveawayBtn = document.getElementById('btn-admin-giveaway'); 
            const aClanAreaBtn = document.getElementById('btn-area-cla');
            const aClanGivBtn = document.getElementById('btn-admin-clan-giveaway');
            const aClanEventPanelBtn = document.getElementById('btn-clan-event-panel'); 
            const recToggle = document.getElementById('luhnny-recruitment-toggle'); 
            const recFormS = document.getElementById('recruitment-form-section'); 
            const recClosedM = document.getElementById('recruitment-closed-message');
            const btnRecNav = document.getElementById('btn-recrutamento');
            const btnAddMemberManual = document.getElementById('btn-add-member-manual');
            const btnAddMemberTab = document.getElementById('btn-add-member-tab');
            
            if (currentUser) {
                lBtn?.classList.add('hidden'); uDisp?.classList.remove('hidden'); document.getElementById('logged-name').innerText = currentUser.name;
                
                if (canManageRec) { 
                    aRecPanel?.classList.remove('hidden'); recToggle?.classList.remove('hidden'); 
                    recToggle.innerText = isRecruitmentOpen ? "FECHAR RECRUTAMENTO" : "ABRIR RECRUTAMENTO"; 
                    recToggle.className = `w-full py-4 rounded-2xl font-bold text-white mb-10 shadow-lg uppercase transition-all ${isRecruitmentOpen ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600'}`; 
                } else { aRecPanel?.classList.add('hidden'); recToggle?.classList.add('hidden'); }

                if (canManageAlliances) { aAllyBtn?.classList.remove('hidden'); } else { aAllyBtn?.classList.add('hidden'); }
                
                // Verificação em tempo real de se o jogador AINDA é um membro oficial
                let isActuallyMember = false;
                if (!currentUser.isAlly) {
                    const nl = currentUser.name.toLowerCase();
                    const isStatic = ALLOWED_MEMBERS.some(m => m.toLowerCase() === nl) && !hiddenStaticMembers.includes(currentUser.name);
                    const isApproved = allApplications.some(app => app.nick.toLowerCase() === nl && app.status === 'aprovado');
                    const isManual = allAuthorizedMembers.some(m => m.nick.toLowerCase() === nl);
                    const isDynamic = allDynamicAllowedMembers.some(m => m.nick.toLowerCase() === nl);
                    isActuallyMember = isStatic || isApproved || isManual || isDynamic;
                }

                if (isActuallyMember) { aClanAreaBtn?.classList.remove('hidden'); } else { aClanAreaBtn?.classList.add('hidden'); }
                
                // AJUSTE: Permite que membros vejam controles de missão, sorteio e evento para dar sugestões
                if (isActuallyMember) { aMissionAdmin?.classList.remove('hidden'); } else { aMissionAdmin?.classList.add('hidden'); }
                if (isActuallyMember) { aClanGivBtn?.classList.remove('hidden'); } else { aClanGivBtn?.classList.add('hidden'); }
                
                if (currentUser) { aEventBtn?.classList.remove('hidden'); } else { aEventBtn?.classList.add('hidden'); }
                if (isActuallyMember) { aClanEventPanelBtn?.classList.remove('hidden'); } else { aClanEventPanelBtn?.classList.add('hidden'); }
                if (currentUser) { aGiveawayBtn?.classList.remove('hidden'); } else { aGiveawayBtn?.classList.add('hidden'); }
                
                if (canManageMembers) {
                    btnAddMemberManual?.classList.remove('hidden'); 
                    btnAddMemberTab?.classList.remove('hidden');
                } else {
                    btnAddMemberManual?.classList.add('hidden'); 
                    btnAddMemberTab?.classList.add('hidden');
                }
                
            } else { 
                lBtn?.classList.remove('hidden'); uDisp?.classList.add('hidden'); aRecPanel?.classList.add('hidden'); aAllyBtn?.classList.add('hidden'); aEventBtn?.classList.add('hidden'); recToggle?.classList.add('hidden'); aGiveawayBtn?.classList.add('hidden'); aClanAreaBtn?.classList.add('hidden'); aMissionAdmin?.classList.add('hidden'); aClanGivBtn?.classList.add('hidden'); aClanEventPanelBtn?.classList.add('hidden'); btnRecNav?.classList.remove('hidden'); btnAddMemberManual?.classList.add('hidden'); btnAddMemberTab?.classList.add('hidden');
            }
            
            if (isRecruitmentOpen) { recFormS?.classList.remove('hidden'); recClosedM?.classList.add('hidden'); } else { recFormS?.classList.add('hidden'); recClosedM?.classList.remove('hidden'); }
            const hBadge = document.getElementById('header-rec-badge'); if (hBadge) { hBadge.innerHTML = isRecruitmentOpen ? '<i data-lucide="megaphone" class="w-4 h-4"></i> Recrutamento Aberto' : '<i data-lucide="lock" class="w-4 h-4"></i> Recrutamento Fechado'; hBadge.className = `bg-white px-5 py-2 rounded-2xl text-xs font-bold uppercase border-2 shadow-2xl flex items-center gap-2 ${isRecruitmentOpen ? 'text-green-600 border-green-200' : 'text-red-600 border-red-200'}`; }
            window.renderAdminApplications(); window.renderMyRecruitmentStatus(); window.renderAlliances(); window.renderEvents(); window.renderClanEvents(); window.renderIdentities(); window.renderMissions(); window.renderGiveaways(); window.renderGiveaways(true); window.renderMembers(); window.renderLogs(); lucide.createIcons();
        };

        onAuthStateChanged(auth, async (u) => {
            if (!u) await signInAnonymously(auth);
            
            // Listeners Firestore para Permissões Dinâmicas
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'permissions'), (s) => {
                s.docs.forEach(doc => { dynamicRoles[doc.id] = doc.data(); });
                window.updateUI();
                if (document.getElementById('mgmt-content-permissions-mgmt') && !document.getElementById('mgmt-content-permissions-mgmt').classList.contains('hidden')) {
                    window.renderPermissionsMgmt();
                }
            });

            // Listener para Permissões Individuais
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'individual_permissions'), (s) => {
                individualPermissions = {};
                s.docs.forEach(doc => {
                    individualPermissions[doc.id] = doc.data().permissions || [];
                });
                window.updateUI();
            });

            // Listener para todos os usuários registrados para que a Luhnny possa vê-los na lista de gerenciamento
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'), (s) => { 
                allUsers = s.docs.map(d => ({id: d.id, ...d.data()})); 
                window.renderIdentities(); 
            });

            // NOVO: Listener para a lista dinâmica de autorizados
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'allowed_list'), (s) => {
                allDynamicAllowedMembers = s.docs.map(d => ({id: d.id, ...d.data()}));
                window.renderAllowedListMgmt();
                window.renderMembers();
                window.renderIdentities();
            });

            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'recruitment'), (s) => { if (s.exists()) { isRecruitmentOpen = s.data().isOpen; initialRecruitmentLoad = false; window.updateUI(); } });
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'hidden_members'), (s) => { hiddenStaticMembers = s.exists() ? (s.data().nicks || []) : []; window.renderMembers(); });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'events'), (s) => { allEvents = s.docs.map(d => ({id:d.id, ...d.data()})); window.renderEvents(); initialEventLoad = false; });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'clan_events'), (s) => { allClanEvents = s.docs.map(d => ({id:d.id, ...d.data()})); window.renderClanEvents(); initialClanEventLoad = false; });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'missions'), (s) => { allMissions = s.docs.map(d => ({id:d.id, ...d.data()})); window.renderMissions(); });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'completed_missions'), (s) => { allCompletedMissions = s.docs.map(d => ({id:d.id, ...d.data()})); window.renderMissions(); });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'alliances'), (s) => { allAlliances = s.docs.map(d => ({id:d.id, ...d.data()})); window.renderAlliances(); });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'alliance_requests'), (s) => { allAllianceRequests = s.docs.map(d => ({id:d.id, ...d.data()})); window.renderAlliances(); });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'recruitment'), (s) => { allApplications = s.docs.map(d => ({id:d.id, ...d.data()})); initialRecruitmentListLoad = false; window.renderAdminApplications(); window.renderMyRecruitmentStatus(); window.renderMembers(); });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'ally_identities'), (s) => { allIdentities = s.docs.map(d => ({id:d.id, ...d.data()})); window.renderIdentities(); });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'member_details'), (s) => { memberDetailsOverrides = {}; s.docs.forEach(d => { memberDetailsOverrides[d.id] = d.data(); }); window.renderMembers(); });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'giveaways'), (s) => { allGiveaways = s.docs.map(d => ({id:d.id, ...d.data()})); window.renderGiveaways(); initialGiveawayLoad = false; });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'clan_giveaways'), (s) => { allClanGiveaways = s.docs.map(d => ({id:d.id, ...d.data()})); window.renderGiveaways(true); initialClanGiveawayLoad = false; });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'authorized_members'), (s) => { allAuthorizedMembers = s.docs.map(d => ({id: d.id, ...d.data()})); window.renderMembers(); });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'logs'), (s) => { allLogs = s.docs.map(d => ({id: d.id, ...d.data()})); window.renderLogs(); });
            
            const saved = localStorage.getItem('afk_user'); if (saved) { currentUser = JSON.parse(saved); window.updateUI(); }
            if (!saved) window.updateUI();
        });

        window.populateAllySelectRegister = () => { const s = document.getElementById('reg-clan'); if(!s) return; let h = '<option value="">Selecionar clã</option><option value="C0RV0S">C0RV0S</option><option value="Tenebris">Tenebris</option>'; allAlliances.forEach(a => { if(a.name!=="C0RV0S" && a.name!=="Tenebris") h += `<option value="${a.name}">${a.name}</option>`; }); s.innerHTML = h; };
        window.openCreateModal = () => { editingEventId = null; editingEventAuthor = null; document.getElementById('modal-admin-event-form').reset(); window.openModal('modal-admin-event'); };
    </script>
</head>
<body class="min-h-screen text-slate-800 pb-20">
    <div id="toast" style="display:none"></div>
    <header class="py-16 px-4 text-center pink-gradient text-white shadow-lg mb-6 relative overflow-hidden">
        <div class="absolute top-6 right-6 md:top-8 md:right-12 recruitment-badge"><div id="header-rec-badge" class="bg-white px-5 py-2 rounded-2xl text-xs font-bold uppercase border-2 border-pink-200 shadow-2xl flex items-center gap-2"><i data-lucide="megaphone" class="w-4 h-4"></i> Recrutamento Aberto</div></div>
        <h1 class="text-6xl font-extrabold tracking-tight mb-2 uppercase">CLÃ AFK</h1>
        <p class="text-pink-50 font-medium opacity-90 uppercase tracking-widest">Criado por Luhnny</p>
        <div class="mt-6 flex justify-center w-full">
            <button id="btn-login-trigger" onclick="window.openModal('modal-login')" class="bg-white text-pink-600 px-8 py-3 rounded-xl text-lg font-bold shadow-2xl transition hover:scale-105 active:scale-95 uppercase tracking-tighter btn-attention flex items-center gap-2"><i data-lucide="log-in" class="w-5 h-5"></i> Acessar Conta</button>
            <div id="user-logged-in" class="hidden bg-white/20 px-4 py-2 rounded-xl text-sm font-semibold flex items-center gap-3"><span>Olá, <strong id="logged-name"></strong></span><button onclick="localStorage.removeItem('afk_user'); location.reload();" class="hover:text-red-200 transition font-bold uppercase text-[10px]">Sair</button></div>
        </div>
    </header>
    <nav class="max-w-6xl mx-auto px-6 mb-10 border-b border-pink-200 text-center"><div class="flex gap-2 md:gap-8 justify-center flex-wrap"><button onclick="window.switchTab('apresentacao')" id="btn-apresentacao" class="pb-3 text-sm md:text-lg font-semibold tab-active transition-all">Apresentação</button><button onclick="window.switchTab('membros')" id="btn-membros" class="pb-3 text-sm md:text-lg font-semibold text-pink-300 transition-all">Membros</button><button onclick="window.switchTab('area-cla')" id="btn-area-cla" class="hidden pb-3 text-sm md:text-lg font-semibold text-pink-300 transition-all">Área do Clã</button><button onclick="window.switchTab('eventos')" id="btn-eventos" class="pb-3 text-sm md:text-lg font-semibold text-pink-300 transition-all">Eventos</button><button onclick="window.switchTab('sorteios')" id="btn-sorteios" class="pb-3 text-sm md:text-lg font-semibold text-pink-300 transition-all">Sorteios</button><button onclick="window.switchTab('aliancas')" id="btn-aliancas" class="pb-3 text-sm md:text-lg font-semibold text-pink-300 transition-all">Alianças</button><button onclick="window.switchTab('recrutamento')" id="btn-recrutamento" class="pb-3 text-sm md:text-lg font-semibold text-pink-300 transition-all">Recrutamento</button><button onclick="window.switchTab('gerenciamento')" id="btn-gerenciamento" class="hidden pb-3 text-sm md:text-lg font-semibold text-pink-300 transition-all">Gerenciamento</button></div></nav>
    <main class="max-w-6xl mx-auto px-6">
        <div id="tab-apresentacao"><div class="bg-white p-8 md:p-12 rounded-3xl card-shadow border border-pink-100 max-w-4xl mx-auto text-center leading-relaxed"><div class="flex justify-center mb-8"><div class="p-2 bg-pink-50 rounded-full border-2 border-pink-100 shadow-inner"><img src="icone.png" onerror="this.src='https://ui-avatars.com/api/?name=AFK&background=f9a8d4&color=fff&size=200'" class="w-32 h-32 md:w-48 md:h-48 rounded-full object-cover"></div></div><h2 class="text-3xl font-bold text-pink-500 mb-6 uppercase"><i data-lucide="sparkles" class="inline w-8 h-8"></i> Breve apresentação</h2><div class="space-y-6 text-slate-600 text-lg text-left leading-relaxed mb-8"><p>O <strong>Clã AFK</strong> nasceu com o propósito de reunir amigos, focado originalmente em <strong>Build</strong> no servidor <strong>bawmc.net</strong>. Porém nossa comunidade evoluiu e hoje em dia nosso clã se encontra tanto em PvP quanto em Build!</p><p>O gerenciamento do clã é exercido pela <strong>Luhnny</strong> como nossa líder, juntamente com o apoio de <strong>AnnyGaby</strong>, <strong>Lagartuuuxaaa</strong> e <strong>K0ssh1_</strong> como nossos co-líderes.</p><p>O objetivo do clã é, e sempre será a diversão. Não toleramos qualquer desrespeito e toxicidade!</p></div><div class="bg-pink-50 p-6 rounded-2xl border-l-4 border-pink-400 flex items-center gap-4 text-left shadow-inner transition-transform hover:scale-[1.01]"><i data-lucide="message-circle" class="text-pink-500 w-10 h-10 flex-shrink-0"></i><p class="text-sm md:text-base font-medium text-slate-700">Qualquer dúvida, entrar em contato com <strong>@luhsch</strong> no Discord!</p></div></div></div>
        <div id="tab-membros" class="hidden">
            <div class="mb-8 flex flex-col md:flex-row justify-between items-center gap-4 text-center md:text-left">
                <div>
                    <h2 class="text-2xl font-bold text-pink-400 flex items-center gap-2 uppercase tracking-wide"><i data-lucide="users"></i> Membros Ativos</h2>
                    <div id="members-count" class="text-sm text-pink-400/70 italic font-medium">Carregando membros...</div>
                </div>
                <div class="flex items-center gap-4">
                    <button id="btn-add-member-tab" onclick="window.openModal('modal-add-member-manual')" class="hidden bg-pink-500 text-white px-6 py-2 rounded-xl text-xs font-bold shadow-lg hover:bg-pink-600 transition flex items-center gap-2 uppercase"><i data-lucide="user-plus"></i> Adicionar Membro</button>
                </div>
            </div>
            <div id="members-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 text-left"></div>
        </div>
        <div id="tab-area-cla" class="hidden"><div class="max-w-4xl mx-auto mb-8 flex justify-center gap-4 flex-wrap"><button onclick="window.switchSubTab('eventos-cla')" id="subbtn-eventos-cla" class="px-6 py-2 rounded-xl font-bold transition-all uppercase text-xs tracking-widest bg-slate-100 text-slate-500 shadow-sm">Eventos do Clã</button><button onclick="window.switchSubTab('sorteios-cla')" id="subbtn-sorteios-cla" class="px-6 py-2 rounded-xl font-bold transition-all uppercase text-xs tracking-widest bg-slate-100 text-slate-500 shadow-sm">Sorteios do Clã</button><button onclick="window.switchSubTab('missoes-cla')" id="subbtn-missoes-cla" class="px-6 py-2 rounded-xl font-bold transition-all uppercase text-xs tracking-widest bg-slate-100 text-slate-500 shadow-sm">Missões do Clã</button></div><div id="subtab-eventos-cla"><div id="clan-suggestions-section" class="hidden mb-12"><h3 class="text-xl font-bold text-purple-500 mb-6 flex items-center gap-2 justify-center uppercase leading-tight"><i data-lucide="message-square"></i> Sugestões Internas</h3><div id="clan-suggested-events-list"></div></div><div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4 text-center md:text-left"><h2 class="text-2xl font-bold text-purple-500 flex items-center gap-2 uppercase tracking-wide"><i data-lucide="swords"></i> Eventos Internos</h2><button id="btn-clan-event-panel" onclick="window.openCreateClanEventModal()" class="hidden bg-purple-500 text-white px-5 py-2 rounded-2xl text-sm font-bold shadow-lg hover:bg-purple-600 transition flex items-center gap-2 mx-auto md:mx-0 uppercase leading-tight"><i data-lucide="plus-circle"></i> Criar / Sugerir</button></div><div id="clan-active-events-list"></div><div id="clan-no-active-message" class="hidden bg-white rounded-3xl card-shadow border-2 border-dashed border-purple-200 p-8 text-center max-w-4xl mx-auto"><h3 class="text-3xl font-extrabold text-purple-400 mb-2 uppercase">Sem eventos internos</h3><p class="text-slate-500 text-lg">Sugira algo novo!</p></div><div class="mt-16 border-t border-purple-100 pt-10 text-left"><h3 class="text-xl font-bold text-slate-400 mb-6 flex items-center gap-2 uppercase tracking-wider leading-tight"><i data-lucide="history"></i> Histórico Interno</h3><div id="clan-history-events-list" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div></div></div><div id="subtab-sorteios-cla" class="hidden"><div id="btn-admin-clan-giveaway" class="hidden mb-8 text-center"><button onclick="window.openCreateGiveawayModal(true)" class="bg-purple-500 text-white px-6 py-3 rounded-2xl font-bold shadow-lg hover:bg-purple-600 transition uppercase flex items-center gap-2 mx-auto"><i data-lucide="gift"></i> Novo Sorteio do Clã</button></div><div id="clan-giveaways-list" class="grid grid-cols-1 gap-6 max-w-3xl mx-auto"></div></div><div id="subtab-missoes-cla" class="hidden"><div id="mission-suggestions-section" class="hidden mb-12"><h3 class="text-xl font-bold text-purple-500 mb-6 flex items-center gap-2 justify-center uppercase leading-tight tracking-tighter"><i data-lucide="message-square"></i> Sugestões de Missão (Luhnny)</h3><div id="suggested-missions-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div></div><div id="admin-mission-controls" class="hidden mb-8 text-center"><button onclick="window.openModal('modal-create-mission')" class="bg-purple-500 text-white px-6 py-3 rounded-2xl font-bold shadow-lg hover:bg-purple-600 transition uppercase tracking-tighter flex items-center gap-2 mx-auto"><i data-lucide="plus-circle"></i> Nova Missão</button></div><div id="missions-list" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div><div class="mt-16 border-t border-purple-100 pt-10 text-left"><h3 class="text-xl font-bold text-slate-400 mb-6 flex items-center gap-2 uppercase tracking-wider leading-tight"><i data-lucide="history"></i> Histórico de Missões</h3><div id="completed-missions-list" class="grid grid-cols-1 gap-3 max-w-4xl mx-auto"></div></div></div></div>
        <div id="tab-eventos" class="hidden"><div id="suggestions-section" class="hidden mb-12"><h3 class="text-xl font-bold text-pink-500 mb-6 flex items-center gap-2 justify-center uppercase leading-tight"><i data-lucide="message-square"></i> Sugestões Pendentes</h3><div id="suggested-events-list"></div></div><div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4 text-center md:text-left"><h2 class="text-2xl font-bold text-pink-400 flex items-center gap-2 uppercase tracking-wide"><i data-lucide="calendar-heart"></i> Cronograma</h2><button id="admin-event-panel" onclick="window.openCreateModal()" class="hidden bg-pink-500 text-white px-5 py-2 rounded-2xl text-sm font-bold shadow-lg hover:bg-pink-600 transition flex items-center gap-2 mx-auto md:mx-0 uppercase leading-tight"><i data-lucide="plus-circle"></i> Criar / Sugerir Evento</button></div><div id="active-events-list"></div><div id="no-active-message" class="hidden bg-white rounded-3xl card-shadow border-2 border-dashed border-pink-200 p-8 text-center max-w-4xl mx-auto"><h3 class="text-3xl font-extrabold text-pink-500 mb-2 uppercase">Sem eventos ativos</h3><p class="text-slate-500 text-lg">Novidades em breve!</p></div><div class="mt-16 border-t border-pink-100 pt-10 text-left"><h3 class="text-xl font-bold text-slate-400 mb-6 flex items-center gap-2 uppercase tracking-wider leading-tight"><i data-lucide="history"></i> Histórico</h3><div id="history-events-list" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div></div></div>
        <div id="tab-sorteios" class="hidden"><div id="btn-admin-giveaway" class="hidden mb-8 text-center"><button onclick="window.openCreateGiveawayModal()" class="bg-pink-50 text-white px-6 py-3 rounded-2xl font-bold shadow-lg hover:bg-pink-600 transition uppercase tracking-tighter flex items-center gap-2 mx-auto"><i data-lucide="gift"></i> Novo Sorteio</button></div><div id="giveaways-list" class="grid grid-cols-1 gap-6 max-w-3xl mx-auto"></div></div>
        <div id="tab-aliancas" class="hidden text-center"><div id="alliance-requests-section" class="hidden mb-12 bg-white p-8 rounded-3xl card-shadow border-2 border-yellow-100 text-center"><h3 class="text-xl font-bold text-yellow-600 mb-6 flex items-center gap-2 justify-center uppercase leading-tight tracking-tighter"><i data-lucide="clock" class="w-6 h-6"></i> Solicitações Pendentes (Luhnny)</h3><div id="alliance-requests-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div></div><div class="flex flex-col md:flex-row justify-between items-center mb-10 gap-4 md:text-left"><h2 class="text-2xl font-bold text-pink-400 flex items-center gap-2 uppercase tracking-wide"><i data-lucide="handshake" class="w-6 h-6"></i> Clãs Aliados</h2><button id="admin-alliance-panel" onclick="window.openModal('modal-admin-alliance')" class="hidden bg-pink-500 text-white px-5 py-2 rounded-2xl text-sm font-bold shadow-lg hover:bg-pink-600 transition uppercase leading-tight tracking-tighter">Adicionar Aliança</button></div><div id="alliances-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div></div>
        <div id="tab-recrutamento" class="hidden text-center"><button id="luhnny-recruitment-toggle" onclick="window.toggleRecruitmentStatus()" class="hidden"></button><div id="admin-recruitment-section" class="hidden mb-12 bg-white p-8 rounded-3xl card-shadow border-2 border-pink-200"><h2 class="text-2xl font-bold text-pink-600 mb-8 flex items-center gap-2 justify-center uppercase">Gerenciar Pedidos</h2><div id="admin-applications-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div></div><div id="my-recruitment-status" class="max-w-3xl mx-auto"></div><div id="recruitment-closed-message" class="hidden bg-white p-12 rounded-3xl card-shadow border-2 border-dashed border-red-200 text-center max-w-3xl mx-auto transition-all"><div class="p-4 bg-red-50 text-red-500 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-6 shadow-inner"><i data-lucide="lock" class="w-8 h-8"></i></div><h2 class="text-3xl font-extrabold text-red-600 mb-2 uppercase leading-tight tracking-tighter">Recrutamento Fechado</h2><p class="text-slate-500 leading-relaxed font-medium">Neste momento não estamos a aceitar candidaturas. Tenta mais tarde!</p></div><div id="recruitment-form-section" class="bg-white p-8 md:p-12 rounded-3xl card-shadow border border-pink-100 max-w-3xl mx-auto text-center"><h2 class="text-3xl font-bold text-pink-500 mb-8 uppercase tracking-tighter">FORMULÁRIO</h2><form id="form-recruitment" onsubmit="event.preventDefault(); window.requestRecruitmentReview();" class="grid grid-cols-1 md:grid-cols-2 gap-6 text-left"><div><label class="block text-sm font-bold text-pink-400 uppercase mb-2 ml-2">Nick*:</label><input type="text" id="rec-nick" required class="w-full p-3 bg-slate-50 border rounded-xl outline-none focus:border-pink-300"></div><div><label class="block text-sm font-bold text-pink-400 uppercase mb-2 ml-2">Discord*:</label><input type="text" id="rec-discord" required class="w-full p-3 bg-slate-50 border rounded-xl outline-none focus:border-pink-300"></div><div><label class="block text-sm font-bold text-pink-400 uppercase mb-2 ml-2">Idade*:</label><input type="number" id="rec-idade" required class="w-full p-3 bg-slate-50 border rounded-xl"></div><div><label class="block text-sm font-bold text-pink-400 uppercase mb-2 ml-2">Tempo de Jogo (h)*:</label><input type="number" id="rec-tempo" required class="w-full p-3 bg-slate-50 border rounded-xl"></div><div><label class="block text-sm font-bold text-pink-400 uppercase mb-2 ml-2">Simple Voice?*</label><select id="rec-voice" required class="w-full p-3 bg-slate-50 border rounded-xl"><option value="Sim">Sim</option><option value="Não">Não</option></select></div><div class="col-span-full"><label class="block text-sm font-bold text-pink-400 uppercase mb-2 ml-2">Clãs anteriores*:</label><input type="text" id="rec-clas" required class="w-full p-3 bg-slate-50 border rounded-xl"></div><div><label class="block text-sm font-bold text-pink-400 uppercase mb-2 ml-2">Bom em:*</label><select id="rec-combate" required class="w-full p-3 bg-slate-50 border rounded-xl"><option value="cpvp">CPVP</option><option value="spvp">SPVP</option><option value="ambos">Ambos</option><option value="nenhum">Nenhum</option></select></div><div><label class="block text-sm font-bold text-pink-400 uppercase mb-2 ml-2">Construção*:</label><select id="rec-build" required class="w-full p-3 bg-slate-50 border rounded-xl"><option value="Sou bom">Sou bom</option><option value="Básico">Básico</option><option value="Não construo">Não construo</option></select></div><div><label class="block text-sm font-bold text-pink-400 uppercase mb-2 ml-2">Farm*:</label><select id="rec-farm" required class="w-full p-3 bg-slate-50 border rounded-xl"><option value="Sou bom">Sou bom</option><option value="Básico">Básico</option><option value="Não faço farm">Não faço farm</option></select></div><div><label class="block text-sm font-bold text-pink-400 uppercase mb-2 ml-2">PC ou Mobile?*</label><select id="rec-plat" required class="w-full p-3 bg-slate-50 border rounded-xl"><option value="PC">PC</option><option value="Mobile">Mobile</option></select></div><div><label class="block text-sm font-bold text-pink-400 uppercase mb-2 ml-2">Rank no bawMC*:</label><input type="text" id="rec-rank" required class="w-full p-3 bg-slate-50 border rounded-xl"></div><div><label class="block text-sm font-bold text-slate-400 uppercase mb-2 ml-2">Aniversário:</label><input type="text" id="rec-aniv" class="w-full p-3 bg-slate-50 border rounded-xl"></div><div class="col-span-full"><label class="block text-sm font-bold text-slate-400 uppercase mb-2 ml-2">Horários:</label><textarea id="rec-horarios" class="w-full p-3 bg-slate-50 border rounded-xl h-16"></textarea></div><button type="submit" class="col-span-full pink-gradient text-white font-bold py-4 rounded-2xl shadow-xl hover:scale-[1.01] transition-all uppercase tracking-widest leading-tight">Enviar Formulário</button></form></div></div>
        
        <!-- ABA GERENCIAMENTO -->
        <div id="tab-gerenciamento" class="hidden">
            <div class="max-w-6xl mx-auto px-6 mb-10 text-center border-b border-pink-100">
                <div class="flex gap-8 justify-center">
                    <button onclick="window.switchMgmtSubTab('logs-mgmt')" id="mgmt-btn-logs-mgmt" class="pb-3 text-sm font-bold uppercase tracking-tighter mgmt-subtab-active transition-all">Logs de Auditoria</button>
                    <button onclick="window.switchMgmtSubTab('permissions-mgmt')" id="mgmt-btn-permissions-mgmt" class="pb-3 text-sm font-bold uppercase tracking-tighter transition-all">Permissões e Acessos</button>
                </div>
            </div>

            <div id="mgmt-content-logs-mgmt" class="">
                <div class="bg-white p-8 rounded-3xl card-shadow border border-pink-100 max-w-5xl mx-auto">
                    <div class="flex items-center justify-between mb-8">
                        <h2 class="text-2xl font-bold text-pink-600 flex items-center gap-2 uppercase"><i data-lucide="scroll-text"></i> Histórico de Ações</h2>
                        <span class="text-xs font-bold text-slate-400 uppercase">Últimos 7 dias</span>
                    </div>
                    <div id="logs-list" class="space-y-3 max-h-[600px] overflow-y-auto pr-2"></div>
                </div>
            </div>

            <div id="mgmt-content-permissions-mgmt" class="hidden">
                <div class="space-y-10">
                    <!-- CONTROLE DE HIERARQUIA ADMINISTRATIVA DINÂMICO -->
                    <div class="bg-white p-8 rounded-3xl card-shadow border-2 border-pink-100 max-w-6xl mx-auto">
                        <div class="flex items-center justify-between mb-8">
                            <h2 class="text-2xl font-bold text-pink-600 flex items-center gap-2 uppercase"><i data-lucide="shield-check"></i> Controle de Hierarquia Administrativa</h2>
                            <span class="bg-pink-100 text-pink-600 px-4 py-1 rounded-lg text-[10px] font-bold uppercase">Gerenciado por Luhnny</span>
                        </div>
                        
                        <div id="dynamic-permissions-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- Preenchido dinamicamente via JS -->
                        </div>
                    </div>

                    <!-- Gestão de Identidades -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 max-w-6xl mx-auto">
                        <div id="member-identities-section" class="bg-white p-8 rounded-3xl card-shadow border-2 border-slate-100">
                            <h3 class="text-xl font-bold text-slate-600 mb-6 uppercase tracking-tighter flex items-center gap-2"><i data-lucide="fingerprint"></i> Identidades: Membros</h3>
                            <div id="member-identities-list" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
                        </div>
                        <div id="ally-identities-section" class="bg-white p-8 rounded-3xl card-shadow border-2 border-slate-100">
                            <h3 class="text-xl font-bold text-slate-600 mb-6 uppercase tracking-tighter flex items-center gap-2"><i data-lucide="fingerprint"></i> Identidades: Aliados</h3>
                            <div id="ally-identities-list" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <footer class="py-10 text-center text-pink-400 text-sm uppercase tracking-tighter font-semibold">Clã AFK fundado em 2025 por Luhnny</footer>
    <!-- MODAIS -->
    <div id="modal-login" class="hidden fixed inset-0 z-[1100] flex items-center justify-center p-4 modal-bg"><div class="bg-white rounded-3xl p-8 w-full max-md shadow-2xl relative overflow-hidden text-center"><div class="flex border-b mb-6"><button id="tab-mode-login" onclick="window.toggleAuthMode('login')" class="flex-1 py-4 text-base font-bold text-pink-600 border-b-2 border-pink-600 uppercase tracking-tighter transition-all">Entrar</button><button id="tab-mode-register" onclick="window.toggleAuthMode('register')" class="flex-1 py-4 text-base font-bold text-slate-400 uppercase tracking-tighter transition-all">Criar Conta</button></div><div id="auth-login-form" class="space-y-4 text-left"><label class="block text-sm font-bold text-slate-400 uppercase mb-1 ml-2">Nick:</label><input type="text" id="login-user" class="w-full bg-slate-50 border-2 p-3 rounded-xl outline-none focus:border-pink-300"><label class="block text-sm font-bold text-slate-400 uppercase mb-1 ml-2">Sua Senha:</label><input type="password" id="login-pass" class="w-full bg-slate-50 border-2 p-3 rounded-xl outline-none focus:border-pink-300"><button onclick="window.handleLogin()" class="w-full pink-gradient text-white font-bold py-3 rounded-xl shadow-lg transition active:scale-95 uppercase mt-4">Acessar</button><button onclick="window.forgotPassword()" class="w-full mt-2 text-pink-400 text-[10px] font-bold uppercase hover:underline text-center">Esqueci minha senha</button></div><div id="auth-register-form" class="hidden space-y-4 text-left"><label class="block text-sm font-bold text-slate-400 uppercase mb-1 ml-2">Nick:</label><input type="text" id="reg-nick" class="w-full bg-slate-50 border-2 p-3 rounded-xl outline-none focus:border-pink-300"><label class="block text-sm font-bold text-slate-400 uppercase mb-1 ml-2">Crie uma Senha:</label><input type="password" id="reg-pass" class="w-full bg-slate-50 border-2 p-3 rounded-xl outline-none focus:border-pink-300"><label class="block text-sm font-bold text-slate-400 uppercase mb-1 ml-2">Tipo de Conta:</label><select id="reg-type" onchange="window.toggleRegisterType()" class="w-full bg-slate-50 border-2 p-3 rounded-xl outline-none focus:border-pink-300"><option value="member">Membro do Clã</option><option value="ally">Aliado</option></select><div id="reg-clan-div" class="hidden"><label class="block text-sm font-bold text-slate-400 uppercase mb-1 ml-2">Selecione seu Clã:</label><select id="reg-clan" class="w-full bg-slate-50 border-2 p-3 rounded-xl outline-none focus:border-pink-300"></select></div><label class="block text-sm font-bold text-pink-500 uppercase mb-1 ml-2">Código de Acesso:</label><input type="password" id="reg-invite" class="w-full bg-pink-50 border-2 border-pink-200 p-3 rounded-xl outline-none focus:border-pink-400 text-pink-600 font-bold placeholder-pink-300" placeholder="Digite o código..."><button onclick="window.handleRegister()" class="w-full bg-slate-800 text-white font-bold py-3 rounded-xl shadow-lg transition active:scale-95 uppercase mt-4">Registrar</button></div><button onclick="window.closeModal('modal-login')" class="w-full text-slate-400 text-xs mt-6 uppercase font-semibold text-center hover:text-pink-400 transition-colors">Fechar janela</button></div></div>
    <div id="modal-confirm-account-reset" class="hidden fixed inset-0 z-[1200] flex items-center justify-center p-4 modal-bg text-center"><div class="bg-white rounded-3xl p-8 w-full max-sm shadow-2xl transition-all"><h3 class="text-xl font-bold mb-4 text-slate-800 uppercase tracking-tighter leading-tight">Resetar Conta?</h3><p class="text-sm text-slate-500 mb-6">Isso apagará o registro de login de <strong id="reset-nick-display" class="text-pink-500"></strong>. O jogador precisará criar uma conta nova.</p><div class="flex gap-4"><button onclick="window.confirmAccountReset()" class="flex-1 bg-pink-500 text-white font-bold py-3 rounded-xl shadow-lg transition hover:bg-pink-600">Sim, Resetar</button><button onclick="window.closeModal('modal-confirm-account-reset')" class="flex-1 bg-slate-100 py-3 rounded-xl font-bold transition text-slate-500 hover:bg-slate-200">Cancelar</button></div></div></div>
    <div id="modal-confirm-rec-delete" class="hidden fixed inset-0 z-[1200] flex items-center justify-center p-4 modal-bg text-center"><div class="bg-white rounded-3xl p-8 w-full max-sm shadow-2xl transition-all"><h3 class="text-xl font-bold mb-6 text-slate-800 uppercase tracking-tighter leading-tight">Remover Candidatura?</h3><div class="flex gap-4"><button onclick="window.confirmRecDelete()" class="flex-1 bg-red-500 text-white font-bold py-3 rounded-xl shadow-lg transition hover:bg-red-600 uppercase">Sim</button><button onclick="window.closeModal('modal-confirm-rec-delete')" class="flex-1 bg-slate-100 py-3 rounded-xl font-bold transition hover:bg-slate-200 text-slate-500 uppercase">Não</button></div></div></div>
    <div id="modal-create-mission" class="hidden fixed inset-0 z-[1100] flex items-center justify-center p-4 modal-bg text-left"><div class="bg-white rounded-3xl p-8 w-full max-w-md shadow-2xl"><h3 class="text-2xl font-bold text-pink-600 mb-6 uppercase tracking-tighter leading-tight">Nova Missão</h3><form id="form-create-mission" onsubmit="event.preventDefault(); window.createMission();" class="space-y-4"><div><label class="block text-sm font-bold text-slate-400 uppercase mb-1 ml-2">Tag:</label><select id="mis-tag" required class="w-full p-3 bg-slate-50 border rounded-xl focus:border-pink-300 outline-none"><option value="Farm">Farm</option><option value="Build">Build</option><option value="Recursos">Recursos</option><option value="Exploração">Exploração</option></select></div><div><label class="block text-sm font-bold text-slate-400 uppercase mb-1 ml-2">Objetivo:</label><input type="text" id="mis-objective" required class="w-full p-3 bg-slate-50 border rounded-xl focus:border-pink-300 outline-none"></div><div><label class="block text-sm font-bold text-slate-400 uppercase mb-1 ml-2">Recompensa:</label><input type="text" id="mis-reward" required class="w-full p-3 bg-slate-50 border rounded-xl focus:border-pink-300 outline-none"></div><button type="submit" class="w-full pink-gradient text-white font-bold py-4 rounded-xl shadow-lg uppercase mt-4">Criar Missão</button></form></div></div>
    <div id="modal-create-giveaway" class="hidden fixed inset-0 z-[1100] flex items-center justify-center p-4 modal-bg text-left"><div class="bg-white rounded-3xl p-8 w-full max-w-md shadow-2xl"><h3 id="modal-title-giveaway" class="text-2xl font-bold text-pink-600 mb-6 uppercase tracking-tighter leading-tight">Novo Sorteio</h3><form id="form-create-giveaway" onsubmit="event.preventDefault(); window.saveGiveaway();" class="space-y-4"><div><label class="block text-sm font-bold text-slate-400 uppercase mb-1 ml-2">Prêmio:</label><input type="text" id="giv-prize" required class="w-full p-3 bg-slate-50 border rounded-xl focus:border-pink-300 outline-none"></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-bold text-slate-400 uppercase mb-1 ml-2">Dia:</label><input type="date" id="giv-date" required class="w-full p-3 bg-slate-50 border rounded-xl"></div><div><label class="block text-sm font-bold text-slate-400 uppercase mb-1 ml-2">Hora:</label><input type="time" id="giv-time" required class="w-full p-3 bg-slate-50 border rounded-xl"></div></div><button type="submit" class="w-full pink-gradient text-white font-bold py-4 rounded-xl shadow-lg uppercase mt-4">Salvar Sorteio</button></form></div></div>
    <div id="modal-create-clan-giveaway" class="hidden fixed inset-0 z-[1100] flex items-center justify-center p-4 modal-bg text-left"><div class="bg-white rounded-3xl p-8 w-full max-md shadow-2xl border-4 border-purple-100"><h3 id="modal-title-clan-giveaway" class="text-2xl font-bold text-purple-600 mb-6 uppercase tracking-tighter leading-tight">Sorteio do Clã</h3><form id="form-create-clan-giveaway" onsubmit="event.preventDefault(); window.saveGiveaway(true);" class="space-y-4"><div><label class="block text-sm font-bold text-slate-400 uppercase mb-1 ml-2">Prêmio:</label><input type="text" id="clan-giv-prize" required class="w-full p-3 bg-slate-50 border rounded-xl focus:border-purple-300 outline-none"></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-bold text-slate-400 uppercase mb-1 ml-2">Dia:</label><input type="date" id="clan-giv-date" required class="p-3 bg-slate-50 border rounded-xl"></div><div><label class="block text-sm font-bold text-slate-400 uppercase mb-1 ml-2">Hora:</label><input type="time" id="clan-giv-time" required class="p-3 bg-slate-50 border rounded-xl"></div></div><button type="submit" class="w-full bg-purple-500 text-white font-bold py-4 rounded-xl shadow-lg uppercase mt-4">Salvar Sorteio</button></form></div></div>
    <div id="modal-admin-alliance" class="hidden fixed inset-0 z-[1100] flex items-center justify-center p-4 modal-bg text-left"><div class="bg-white rounded-3xl p-8 w-full max-md shadow-2xl"><h3 class="text-2xl font-bold text-pink-600 mb-6 uppercase tracking-tighter">Nova Aliança</h3><div class="space-y-4"><div><label class="block text-sm font-bold text-slate-400 uppercase mb-1 ml-2">Nome do Clã:</label><input type="text" id="ali-name" class="w-full p-3 bg-slate-50 border rounded-xl focus:border-pink-300 outline-none"></div><div><label class="block text-sm font-bold text-slate-400 uppercase mb-1 ml-2">TAG do Clã:</label><input type="text" id="ali-tag" class="w-full p-3 bg-slate-50 border rounded-xl focus:border-pink-300 outline-none"></div><button onclick="window.publishClanAlliance()" class="w-full pink-gradient text-white font-bold py-4 rounded-xl shadow-lg uppercase mt-4">Confirmar</button></div></div></div>
    <div id="modal-add-member-manual" class="hidden fixed inset-0 z-[1100] flex items-center justify-center p-4 modal-bg text-left"><div class="bg-white rounded-3xl p-8 w-full max-w-md shadow-2xl border-4 border-pink-100"><h3 class="text-2xl font-bold text-pink-600 mb-6 uppercase tracking-tighter">Autorizar Membro</h3><div class="space-y-4"><div><label class="block text-sm font-bold text-slate-400 uppercase mb-1 ml-2">Nick do Jogador:</label><input type="text" id="add-manual-nick" class="w-full p-3 bg-slate-50 border rounded-xl focus:border-pink-300 outline-none"></div><button onclick="window.addMemberManual()" class="w-full pink-gradient text-white font-bold py-4 rounded-xl shadow-lg uppercase mt-4">Autorizar</button></div></div></div>
    <div id="modal-view-participants" class="hidden fixed inset-0 z-[1150] flex items-center justify-center p-4 modal-bg text-left"><div class="bg-white rounded-3xl p-8 w-full max-md shadow-2xl max-h-[80vh] flex flex-col"><div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-slate-700 uppercase tracking-tighter">Participantes</h3><span id="participants-total-count" class="bg-pink-100 text-pink-600 text-xs font-bold px-3 py-1 rounded-full">0</span></div><div id="participants-list-content" class="flex-grow overflow-y-auto space-y-2 pr-2"></div><button onclick="window.closeModal('modal-view-participants')" class="mt-6 w-full bg-slate-100 text-slate-500 font-bold py-3 rounded-xl uppercase text-sm">Fechar</button></div></div>
    <div id="modal-admin-event" class="hidden fixed inset-0 z-[1100] flex items-center justify-center p-4 modal-bg text-left"><div class="bg-white rounded-3xl p-8 w-full max-w-2xl max-h-[90vh] overflow-y-auto shadow-2xl"><h3 class="text-2xl font-bold text-pink-600 mb-6 uppercase">Configurar Evento Global</h3><form id="modal-admin-event-form" onsubmit="event.preventDefault(); window.publishClanEvent();"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><input type="text" id="ev-title" placeholder="Título*" required class="p-3 bg-slate-50 border rounded-xl outline-none"><input type="text" id="ev-theme" placeholder="Tema*" required class="p-3 bg-slate-50 border rounded-xl outline-none"><input type="date" id="ev-date" required class="p-3 bg-slate-50 border rounded-xl"><input type="time" id="ev-time" class="p-3 bg-slate-50 border rounded-xl"><input type="text" id="ev-loc" placeholder="Local" class="p-3 bg-slate-50 border rounded-xl"><div class="md:col-span-2 space-y-2"><label class="text-[10px] font-bold text-pink-400 uppercase">Prêmios:</label><input type="text" id="ev-p1" class="w-full p-2 border rounded-lg text-sm"><input type="text" id="ev-p2" class="w-full p-2 border rounded-lg text-sm"><input type="text" id="ev-p3" class="w-full p-2 border rounded-lg text-sm"></div></div><textarea id="ev-rules" placeholder="Regras..." required class="w-full p-4 bg-slate-50 border rounded-xl h-24 mb-6 mt-4 outline-none"></textarea><button type="submit" class="w-full pink-gradient text-white font-bold py-3 rounded-xl shadow-lg uppercase">Salvar Evento</button></form></div></div>
    <div id="modal-clan-event" class="hidden fixed inset-0 z-[1100] flex items-center justify-center p-4 modal-bg text-left"><div class="bg-white rounded-3xl p-8 w-full max-w-2xl max-h-[90vh] overflow-y-auto shadow-2xl border-4 border-purple-100"><h3 class="text-2xl font-bold text-purple-600 mb-6 uppercase">Evento do Clã</h3><form id="modal-clan-event-form" onsubmit="event.preventDefault(); window.publishClanEventData();"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><input type="text" id="clan-ev-title" placeholder="Título*" required class="p-3 bg-slate-50 border rounded-xl outline-none"><input type="text" id="clan-ev-theme" placeholder="Tema*" required class="p-3 bg-slate-50 border rounded-xl outline-none"><input type="date" id="clan-ev-date" required class="p-3 bg-slate-50 border rounded-xl"><input type="time" id="clan-ev-time" class="p-3 bg-slate-50 border rounded-xl"><input type="text" id="clan-ev-loc" placeholder="Local" class="p-3 bg-slate-50 border rounded-xl"><div class="md:col-span-2 space-y-2"><label class="text-[10px] font-bold text-purple-400 uppercase">Prêmios:</label><input type="text" id="clan-ev-p1" class="w-full p-2 border rounded-lg text-sm"><input type="text" id="clan-ev-p2" class="w-full p-2 border rounded-lg text-sm"><input type="text" id="clan-ev-p3" class="w-full p-2 border rounded-lg text-sm"></div></div><textarea id="clan-ev-rules" placeholder="Regras..." required class="w-full p-4 bg-slate-50 border rounded-xl h-24 mb-6 mt-4 outline-none"></textarea><button type="submit" class="w-full bg-purple-500 text-white font-bold py-3 rounded-xl shadow-lg uppercase transition">Salvar Evento</button></form></div></div>
    <div id="modal-confirm-mission-delete" class="hidden fixed inset-0 z-[1200] flex items-center justify-center p-4 modal-bg text-center"><div class="bg-white rounded-3xl p-8 w-full max-sm shadow-2xl transition-all"><h3 class="text-xl font-bold mb-6 text-slate-800 uppercase tracking-tighter leading-tight">Concluir/Excluir?</h3><div class="flex gap-4"><button onclick="window.confirmMissionDelete()" class="flex-1 bg-red-500 text-white font-bold py-3 rounded-xl shadow-lg transition hover:bg-red-600 uppercase">Sim</button><button onclick="window.closeModal('modal-confirm-mission-delete')" class="flex-1 bg-slate-100 py-3 rounded-xl font-bold transition hover:bg-slate-200 text-slate-500 uppercase">Não</button></div></div></div>
    <div id="modal-confirm-delete" class="hidden fixed inset-0 z-[1200] flex items-center justify-center p-4 modal-bg text-center"><div class="bg-white rounded-3xl p-8 w-full max-sm shadow-2xl"><h3 class="text-xl font-bold mb-6 uppercase text-slate-800">Eliminar Evento?</h3><div class="flex gap-4"><button onclick="window.confirmDelete()" class="flex-1 bg-red-500 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-red-600 uppercase">Sim</button><button onclick="window.closeModal('modal-confirm-delete')" class="flex-1 bg-slate-100 py-3 rounded-xl font-bold text-slate-500 uppercase">Não</button></div></div></div>
    <div id="modal-confirm-giveaway-delete" class="hidden fixed inset-0 z-[1200] flex items-center justify-center p-4 modal-bg text-center"><div class="bg-white rounded-3xl p-8 w-full max-sm shadow-2xl transition-all"><h3 class="text-xl font-bold mb-6 text-slate-800 uppercase tracking-tighter leading-tight">Deletar Sorteio?</h3><div class="flex gap-4"><button onclick="window.confirmGiveawayDelete()" class="flex-1 bg-red-500 text-white font-bold py-3 rounded-xl shadow-lg transition hover:bg-red-600 uppercase">Sim</button><button onclick="window.closeModal('modal-confirm-giveaway-delete')" class="flex-1 bg-slate-100 py-3 rounded-xl font-bold transition hover:bg-slate-200 text-slate-500 uppercase">Não</button></div></div></div>
    <div id="modal-confirm-clan-giveaway-delete" class="hidden fixed inset-0 z-[1200] flex items-center justify-center p-4 modal-bg text-center"><div class="bg-white rounded-3xl p-8 w-full max-sm shadow-2xl transition-all"><h3 class="text-xl font-bold mb-6 text-slate-800 uppercase tracking-tighter leading-tight">Deletar Sorteio do Clã?</h3><div class="flex gap-4"><button onclick="window.confirmGiveawayDelete(true)" class="flex-1 bg-red-500 text-white font-bold py-3 rounded-xl shadow-lg transition hover:bg-red-600 uppercase">Sim</button><button onclick="window.closeModal('modal-confirm-clan-giveaway-delete')" class="flex-1 bg-slate-100 py-3 rounded-xl font-bold transition hover:bg-slate-200 text-slate-500 uppercase">Não</button></div></div></div>
    <div id="modal-confirm-alliance-delete" class="hidden fixed inset-0 z-[1200] flex items-center justify-center p-4 modal-bg text-center"><div class="bg-white rounded-3xl p-8 w-full max-sm shadow-2xl transition-all"><h3 class="text-xl font-bold mb-6 text-slate-800 uppercase tracking-tighter leading-tight">Remover Aliança?</h3><div class="flex gap-4"><button onclick="window.confirmAllianceDelete()" class="flex-1 bg-red-500 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-red-600 uppercase">Sim</button><button onclick="window.closeModal('modal-confirm-alliance-delete')" class="flex-1 bg-slate-100 py-3 rounded-xl font-bold transition text-slate-500 uppercase">Não</button></div></div></div>
    <div id="modal-confirm-member-delete" class="hidden fixed inset-0 z-[1200] flex items-center justify-center p-4 modal-bg text-center"><div class="bg-white rounded-3xl p-8 w-full max-sm shadow-2xl transition-all"><h3 class="text-xl font-bold mb-6 text-slate-800 uppercase tracking-tighter leading-tight">Remover Membro?</h3><div class="flex gap-4"><button onclick="window.confirmMemberDelete()" class="flex-1 bg-red-500 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-red-600 uppercase">Sim</button><button onclick="window.closeModal('modal-confirm-member-delete')" class="flex-1 bg-slate-100 py-3 rounded-xl font-bold transition text-slate-500 uppercase">Não</button></div></div></div>
    <div id="modal-edit-member" class="hidden fixed inset-0 z-[1200] flex items-center justify-center p-4 modal-bg text-left"><div class="bg-white rounded-3xl p-8 w-full max-w-md shadow-2xl transition-all"><h3 class="text-xl font-bold mb-6 text-slate-800 uppercase tracking-tighter leading-tight">Editar Membro: <span id="edit-mem-nick" class="text-pink-500"></span></h3><div class="space-y-4"><div><label class="block text-xs font-bold text-slate-400 uppercase mb-1">Aniversário:</label><input type="text" id="edit-mem-aniv" class="w-full p-3 bg-slate-50 border rounded-xl outline-none"></div><div><label class="block text-xs font-bold text-slate-400 uppercase mb-1">Disponibilidade:</label><input type="text" id="edit-mem-disp" class="w-full p-3 bg-slate-50 border rounded-xl outline-none"></div><div><label class="block text-xs font-bold text-slate-400 uppercase mb-1">Tags:</label><input type="text" id="edit-mem-tags" class="w-full p-3 bg-slate-50 border rounded-xl outline-none"></div><div><label class="block text-xs font-bold text-slate-400 uppercase mb-1">Foto:</label><input type="file" id="edit-mem-img-input" accept="image/*" class="w-full text-xs text-slate-500 cursor-pointer"></div></div><div class="flex gap-4 mt-8"><button onclick="window.saveMemberEdit()" class="flex-1 pink-gradient text-white font-bold py-3 rounded-xl shadow-lg uppercase">Salvar</button><button onclick="window.closeModal('modal-edit-member')" class="flex-1 bg-slate-100 py-3 rounded-xl font-bold text-slate-500 uppercase">Cancelar</button></div></div></div>
    
    <!-- MODAL: PERMISSÕES INDIVIDUAIS -->
    <div id="modal-individual-permissions" class="hidden fixed inset-0 z-[1300] flex items-center justify-center p-4 modal-bg text-left"><div class="bg-white rounded-3xl p-8 w-full max-w-lg shadow-2xl transition-all max-h-[90vh] flex flex-col"><h3 class="text-2xl font-bold mb-2 text-pink-600 uppercase tracking-tighter leading-tight">Acessos de: <span id="indiv-perm-nick"></span></h3><p class="text-xs text-slate-400 mb-6 uppercase font-bold italic">Estas permissões ignoram o cargo do jogador.</p><div id="indiv-perms-checkboxes" class="flex-grow overflow-y-auto space-y-2 pr-2"></div><div class="flex gap-4 mt-8"><button onclick="window.closeModal('modal-individual-permissions')" class="flex-1 pink-gradient text-white font-bold py-3 rounded-xl shadow-lg uppercase">Fechar e Salvar</button></div></div></div>
</body>
</html>
